---
import { getDisplayBadge, getStatusLabel } from '../lib/status.js';

const { groups = [], nodes = [], base = '/', proofIndex = null } = Astro.props;

const nodeIndex = new Map(nodes.map((node) => [node.id, node]));

const nodesByGroup = groups.reduce((acc, group) => {
  acc[group.id] = nodes
    .filter((node) => node.group === group.id)
    .map((node) => ({
      ...node,
      proof: proofIndex && node.proof_id ? proofIndex.get(node.proof_id) : null,
    }));
  return acc;
}, {});

const normalizedBase = base.endsWith('/') ? base : `${base}/`;
const withBase = (path) => (path ? `${normalizedBase}${path.replace(/^\/+/, '')}` : null);
const proofHref = (proof) => (proof ? `${normalizedBase}docs/evidence#claim-${proof.id}` : null);

const statusLabel = (status) => getStatusLabel(status);
const proofStatusLabel = (status) => (status ? getStatusLabel(status) : '');
const statusClass = (node) => getDisplayBadge({ status: node.status, origin: node.origin }).className;
const statusText = (node) => getDisplayBadge({ status: node.status, origin: node.origin }).label;
const statusAccent = (node) => {
  if (node.origin === 'external') {
    return 'border-l-4 border-line/40';
  }
  switch (node.status) {
    case 'current':
      return 'border-l-4 border-text-secondary/70';
    case 'building':
      return 'border-l-4 border-mint/70';
    case 'future':
      return 'border-l-4 border-future/70';
    default:
      return 'border-l-4 border-line/40';
  }
};

const moduleNodes = nodesByGroup.modules || [];
const clusterOrder = [
  'Standards + Contracts',
  'Knowledge + Context',
  'Proof + Validation',
  'Runtime Control',
  'Scaffolds',
];
const moduleClusters = clusterOrder
  .map((label) => ({
    label,
    nodes: moduleNodes.filter((node) => node.cluster === label),
  }))
  .filter((cluster) => cluster.nodes.length > 0);
const clusteredIds = new Set(
  moduleClusters.flatMap((cluster) => cluster.nodes.map((node) => node.id)),
);
const ungroupedModules = moduleNodes.filter((node) => !clusteredIds.has(node.id));
if (ungroupedModules.length) {
  moduleClusters.push({ label: 'Other', nodes: ungroupedModules });
}

const improveTarget = (improvement) => {
  const targetId = (improvement.motus_nodes || [])[0];
  const target = targetId ? nodeIndex.get(targetId) : null;
  if (!target) return null;
  return {
    label: target.label,
    href: target.website_path ? withBase(target.website_path) : normalizeHref(target.docs_url),
  };
};
const normalizeHref = (href) => {
  if (!href) return null;
  return href.startsWith('http') ? href : withBase(href);
};
---

<div class="md:hidden space-y-phi-4">
  {groups.map((group, index) => {
    const groupNodes = nodesByGroup[group.id] || [];
    const nextLane = groups[index + 1]?.label;
    const clusters = group.id === 'modules' ? moduleClusters : null;

    return (
      <section class="space-y-phi-2">
        <div class="flex items-center justify-between gap-phi-2">
          <div class="flex items-center gap-phi-2 text-xs uppercase tracking-[0.3em] text-text-secondary">
            <span>Layer</span>
            <span class="text-text-primary">{group.label}</span>
          </div>
          {group.id === 'core' ? (
            <span class="text-xs uppercase tracking-[0.2em] text-text-secondary">Center</span>
          ) : null}
        </div>
        <p class="text-sm text-text-secondary">{group.description}</p>
        {group.relation ? (
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary/70">
            {group.relation}
          </p>
        ) : null}

        {clusters ? (
          <div class="space-y-phi-2">
            {clusters.map((cluster) => (
              <div class="rounded-2xl border border-line/30 bg-surface-muted p-phi-2 space-y-phi-2">
                <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{cluster.label}</p>
                <div class="space-y-phi-2">
                  {cluster.nodes.map((node) => {
                    const siteHref = node.website_path ? withBase(node.website_path) : null;
                    const docsHref = normalizeHref(node.docs_url);
                    const showSite = siteHref && siteHref !== docsHref;
                    return (
                    <div class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1 ${statusAccent(node)}`.trim()}>
                      <div class="flex items-center justify-between gap-phi-2">
                        <div class="flex items-center gap-phi-2">
                          {node.logo ? (
                            <img
                              src={withBase(node.logo)}
                              alt={node.label}
                              class="h-7 w-7 object-contain flex-shrink-0"
                              loading="lazy"
                            />
                          ) : (
                            <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                          )}
                          <span class="text-sm text-text-primary font-medium">{node.label}</span>
                        </div>
                        <span class={statusClass(node)}>{statusText(node)}</span>
                      </div>
                      <p class="text-sm text-text-secondary">
                        {node.flow_note || node.summary}
                      </p>
                      {node.improves?.length ? (
                        <div class="space-y-phi-1">
                          <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                          <ul class="text-sm text-text-secondary space-y-phi-1">
                            {node.improves.slice(0, 3).map((improvement) => {
                              const target = improveTarget(improvement);
                              return (
                                <li>
                                  <span>{improvement.label}</span>
                                  {target ? (
                                    <>
                                      <span class="text-text-secondary/60"> 路 </span>
                                      <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                        {target.label}
                                      </a>
                                    </>
                                  ) : null}
                                </li>
                              );
                            })}
                          </ul>
                        </div>
                      ) : null}
                      <div class="flex flex-wrap gap-phi-1 text-xs">
                        {showSite ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                            Site
                          </a>
                        ) : null}
                        {docsHref ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                            Docs
                          </a>
                        ) : null}
                        {node.proof ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                            Proof ({proofStatusLabel(node.proof.status)})
                          </a>
                        ) : null}
                        {node.external_url ? (
                          <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                            External
                          </a>
                        ) : null}
                      </div>
                    </div>
                  );})}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="space-y-phi-2">
            {groupNodes.map((node) => {
              const siteHref = node.website_path ? withBase(node.website_path) : null;
              const docsHref = normalizeHref(node.docs_url);
              const showSite = siteHref && siteHref !== docsHref;
              return (
              <div class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1 ${statusAccent(node)}`.trim()}>
                <div class="flex items-center justify-between gap-phi-2">
                  <div class="flex items-center gap-phi-2">
                    {node.logo ? (
                      <img
                        src={withBase(node.logo)}
                        alt={node.label}
                        class="h-7 w-7 object-contain flex-shrink-0"
                        loading="lazy"
                      />
                    ) : (
                      <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                    )}
                    <span class="text-sm text-text-primary font-medium">{node.label}</span>
                  </div>
                  <span class={statusClass(node)}>{statusText(node)}</span>
                </div>
                <p class="text-sm text-text-secondary">
                  {node.flow_note || node.summary}
                </p>
                {node.improves?.length ? (
                  <div class="space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                    <ul class="text-sm text-text-secondary space-y-phi-1">
                      {node.improves.slice(0, 3).map((improvement) => {
                        const target = improveTarget(improvement);
                        return (
                          <li>
                            <span>{improvement.label}</span>
                            {target ? (
                              <>
                                <span class="text-text-secondary/60"> 路 </span>
                                <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                  {target.label}
                                </a>
                              </>
                            ) : null}
                          </li>
                        );
                      })}
                    </ul>
                  </div>
                ) : null}
                <div class="flex flex-wrap gap-phi-1 text-xs">
                  {showSite ? (
                    <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                      Site
                    </a>
                  ) : null}
                  {docsHref ? (
                    <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                      Docs
                    </a>
                  ) : null}
                  {node.proof ? (
                    <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                      Proof ({proofStatusLabel(node.proof.status)})
                    </a>
                  ) : null}
                  {node.external_url ? (
                    <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                      External
                    </a>
                  ) : null}
                </div>
              </div>
            );})}
          </div>
        )}

        {nextLane ? (
          <div class="text-xs uppercase tracking-[0.3em] text-text-secondary flex items-center gap-phi-2">
            <span class="text-text-secondary/60">&#8729;</span>
            <span>Linked to {nextLane}</span>
          </div>
        ) : null}
      </section>
    );
  })}
</div>

<div class="hidden md:grid md:gap-phi-1 md:items-start md:grid-cols-3 md:grid-rows-3">
  {groups.map((group) => {
    const groupNodes = nodesByGroup[group.id] || [];
    const clusters = group.id === 'modules' ? moduleClusters : null;
    const placement = group.id === 'core'
      ? 'md:col-start-2 md:row-start-2'
      : group.id === 'inputs'
        ? 'md:col-start-2 md:row-start-1'
        : group.id === 'modules'
          ? 'md:col-start-1 md:row-start-2'
          : group.id === 'governance'
            ? 'md:col-start-3 md:row-start-2'
            : 'md:col-start-2 md:row-start-3';
    return (
      <div class={`space-y-phi-1 lane-column ${placement}`.trim()}>
          <div class="flex items-center justify-between gap-phi-2">
            <div class="flex items-center gap-phi-2 text-xs uppercase tracking-[0.3em] text-text-secondary">
              <span>Layer</span>
              <span class="text-text-primary">{group.label}</span>
            </div>
            {group.id === 'core' ? (
              <span class="text-xs uppercase tracking-[0.2em] text-text-secondary">Center</span>
            ) : null}
          </div>
          <div class="rounded-2xl border border-line/30 bg-surface-muted p-phi-1 space-y-phi-1">
            <div class="space-y-phi-1">
              <p class="text-sm text-text-secondary">{group.description}</p>
              {group.relation ? (
                <p class="text-xs uppercase tracking-[0.25em] text-text-secondary/70">
                  {group.relation}
                </p>
              ) : null}
            </div>
            <div class="space-y-phi-1">
              {clusters ? (
                <div class="space-y-phi-1">
                  {clusters.map((cluster) => (
                    <div class="rounded-2xl border border-line/30 bg-surface px-phi-2 py-phi-1 space-y-phi-1">
                      <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{cluster.label}</p>
                      <div class="space-y-phi-1">
                        {cluster.nodes.map((node) => {
                          const siteHref = node.website_path ? withBase(node.website_path) : null;
                          const docsHref = normalizeHref(node.docs_url);
                          const showSite = siteHref && siteHref !== docsHref;
                          return (
                          <div class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-1 space-y-phi-1 ${statusAccent(node)}`.trim()}>
                            <div class="flex items-center justify-between gap-phi-2">
                              <div class="flex items-center gap-phi-2">
                                {node.logo ? (
                                  <img
                                    src={withBase(node.logo)}
                                    alt={node.label}
                                    class="h-6 w-6 object-contain flex-shrink-0"
                                    loading="lazy"
                                  />
                                ) : (
                                  <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                                )}
                                <span class="text-sm text-text-primary font-medium">{node.label}</span>
                              </div>
                              <span class={statusClass(node)}>{statusText(node)}</span>
                            </div>
                            <p class="text-sm text-text-secondary">
                              {node.flow_note || node.summary}
                            </p>
                            {node.improves?.length ? (
                              <div class="space-y-phi-1">
                                <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                                <ul class="text-sm text-text-secondary space-y-phi-1">
                                  {node.improves.slice(0, 3).map((improvement) => {
                                    const target = improveTarget(improvement);
                                    return (
                                      <li>
                                        <span>{improvement.label}</span>
                                        {target ? (
                                          <>
                                            <span class="text-text-secondary/60"> 路 </span>
                                            <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                              {target.label}
                                            </a>
                                          </>
                                        ) : null}
                                      </li>
                                    );
                                  })}
                                </ul>
                              </div>
                            ) : null}
                            <div class="flex flex-wrap gap-phi-1 text-sm">
                              {showSite ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                                  Site
                                </a>
                              ) : null}
                              {docsHref ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                                  Docs
                                </a>
                              ) : null}
                              {node.proof ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                                  Proof ({proofStatusLabel(node.proof.status)})
                                </a>
                              ) : null}
                              {node.external_url ? (
                                <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                                  External
                                </a>
                              ) : null}
                            </div>
                          </div>
                        );})}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div class="space-y-phi-1">
                  {groupNodes.map((node) => {
                    const siteHref = node.website_path ? withBase(node.website_path) : null;
                    const docsHref = normalizeHref(node.docs_url);
                    const showSite = siteHref && siteHref !== docsHref;
                    return (
                    <div class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-1 space-y-phi-1 ${statusAccent(node)}`.trim()}>
                      <div class="flex items-center justify-between gap-phi-2">
                        <div class="flex items-center gap-phi-2">
                          {node.logo ? (
                            <img
                              src={withBase(node.logo)}
                              alt={node.label}
                              class="h-6 w-6 object-contain flex-shrink-0"
                              loading="lazy"
                            />
                          ) : (
                            <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                          )}
                          <span class="text-sm text-text-primary font-medium">{node.label}</span>
                        </div>
                        <span class={statusClass(node)}>{statusText(node)}</span>
                      </div>
                      <p class="text-sm text-text-secondary">
                        {node.flow_note || node.summary}
                      </p>
                      {node.improves?.length ? (
                        <div class="space-y-phi-1">
                          <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                          <ul class="text-sm text-text-secondary space-y-phi-1">
                            {node.improves.slice(0, 3).map((improvement) => {
                              const target = improveTarget(improvement);
                              return (
                                <li>
                                  <span>{improvement.label}</span>
                                  {target ? (
                                    <>
                                      <span class="text-text-secondary/60"> 路 </span>
                                      <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                        {target.label}
                                      </a>
                                    </>
                                  ) : null}
                                </li>
                              );
                            })}
                          </ul>
                        </div>
                      ) : null}
                      <div class="flex flex-wrap gap-phi-1 text-sm">
                        {showSite ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                            Site
                          </a>
                        ) : null}
                        {docsHref ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                            Docs
                          </a>
                        ) : null}
                        {node.proof ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                            Proof ({proofStatusLabel(node.proof.status)})
                          </a>
                        ) : null}
                        {node.external_url ? (
                          <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                            External
                          </a>
                        ) : null}
                      </div>
                    </div>
                  );})}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  })}
</div>
