---
import Panel from './Panel.astro';
import { getDisplayBadge, getStatusLabel } from '../lib/status.js';

const { groups = [], nodes = [], base = '/', proofIndex = null } = Astro.props;

const orderedGroups = [...groups].sort((a, b) => (a.position ?? 0) - (b.position ?? 0));
const groupIndex = new Map(groups.map((group) => [group.id, group]));

const nodesByGroup = orderedGroups.reduce((acc, group) => {
  acc[group.id] = nodes
    .filter((node) => node.group === group.id)
    .map((node) => ({
      ...node,
      proof: proofIndex && node.proof_id ? proofIndex.get(node.proof_id) : null,
    }));
  return acc;
}, {});

const normalizedBase = base.endsWith('/') ? base : `${base}/`;
const withBase = (path) => (path ? `${normalizedBase}${path.replace(/^\/+/, '')}` : null);
const normalizeHref = (href) => {
  if (!href) return null;
  return href.startsWith('http') ? href : withBase(href);
};
const proofHref = (proof) => (proof ? `${normalizedBase}docs/evidence#claim-${proof.id}` : null);

const statusClass = (node) => getDisplayBadge({ status: node.status, origin: node.origin }).className;
const statusText = (node) => getDisplayBadge({ status: node.status, origin: node.origin }).label;
const proofStatusLabel = (status) => (status ? getStatusLabel(status) : '');
const statusOpacity = (node) => {
  if (node.status === 'future') return 'opacity-70';
  if (node.status === 'building') return 'opacity-85';
  return 'opacity-100';
};
const statusAccent = (node) => {
  if (node.origin === 'external') {
    return 'border-l-4 border-line/40';
  }
  switch (node.status) {
    case 'current':
      return 'border-l-4 border-text-secondary/70';
    case 'building':
      return 'border-l-4 border-mint/70';
    case 'future':
      return 'border-l-4 border-future/70';
    default:
      return 'border-l-4 border-line/40';
  }
};

const moduleNodes = nodesByGroup.modules || [];
const clusterOrder = [
  'Standards + Contracts',
  'Knowledge + Context',
  'Proof + Validation',
  'Runtime Control',
  'Scaffolds',
];
const moduleClusters = clusterOrder
  .map((label) => ({
    label,
    nodes: moduleNodes.filter((node) => node.cluster === label),
  }))
  .filter((cluster) => cluster.nodes.length > 0);
const clusteredIds = new Set(
  moduleClusters.flatMap((cluster) => cluster.nodes.map((node) => node.id)),
);
const ungroupedModules = moduleNodes.filter((node) => !clusteredIds.has(node.id));
if (ungroupedModules.length) {
  moduleClusters.push({ label: 'Other', nodes: ungroupedModules });
}

const improveTarget = (improvement) => {
  const targetId = (improvement.motus_nodes || [])[0];
  const target = targetId ? nodes.find((node) => node.id === targetId) : null;
  if (!target) return null;
  return {
    label: target.label,
    href: target.website_path ? withBase(target.website_path) : normalizeHref(target.docs_url),
  };
};

const flowLabels = (group) =>
  (group.flow_to || [])
    .map((targetId) => groupIndex.get(targetId)?.label)
    .filter(Boolean);

const countStatuses = (groupNodes) => {
  const counts = { current: 0, building: 0, future: 0, external: 0 };
  groupNodes.forEach((node) => {
    if (node.origin === 'external') counts.external += 1;
    if (counts[node.status] !== undefined) counts[node.status] += 1;
  });
  return counts;
};

---

<div class="space-y-phi-3">
  <div class="rounded-3xl border border-line/30 bg-surface-muted p-phi-2">
    <div class="flex flex-wrap items-stretch gap-phi-1">
      {orderedGroups.filter((group) => group.id !== 'modules').map((group, index, array) => {
        const groupNodes = nodesByGroup[group.id] || [];
        const counts = countStatuses(groupNodes);
        const flow = flowLabels(group);
        const isExternalOnly = groupNodes.length > 0 && groupNodes.every((node) => node.origin === 'external');
        return (
          <div class="flex items-stretch gap-phi-1">
            <div class="flex-1 min-w-[10rem] rounded-2xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1">
              <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{group.label}</p>
              <h3 class="text-base font-display text-text-primary">{group.headline}</h3>
              <p class="text-sm text-text-secondary">{group.description}</p>
              {flow.length ? (
                <p class="text-xs uppercase tracking-[0.25em] text-text-secondary/70">
                  Flow → {flow.join(' · ')}
                </p>
              ) : null}
              <div class="flex flex-wrap gap-phi-1 text-xs">
                {isExternalOnly ? (
                  <span class="status-chip status-external">{counts.external} External</span>
                ) : (
                  <>
                    {counts.current > 0 ? (
                      <span class="status-chip status-current">{counts.current} Current</span>
                    ) : null}
                    {counts.building > 0 ? (
                      <span class="status-chip status-building">{counts.building} Building</span>
                    ) : null}
                    {counts.future > 0 ? (
                      <span class="status-chip status-future">{counts.future} Future</span>
                    ) : null}
                  </>
                )}
              </div>
            </div>
            {index < array.length - 1 ? (
              <div class="flex items-center px-phi-1 text-text-secondary/60 text-lg">&#8594;</div>
            ) : null}
          </div>
        );
      })}
    </div>

    {nodesByGroup.modules?.length ? (
      <div class="mt-phi-2 flex flex-col items-center gap-phi-1">
        <span class="text-text-secondary/60 text-lg">&#8595;</span>
        <div class="max-w-2xl w-full">
          {(() => {
            const group = orderedGroups.find((entry) => entry.id === 'modules');
            if (!group) return null;
            const groupNodes = nodesByGroup.modules || [];
            const counts = countStatuses(groupNodes);
            const flow = flowLabels(group);
            return (
              <div class="rounded-2xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1">
                <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{group.label}</p>
                <h3 class="text-base font-display text-text-primary">{group.headline}</h3>
                <p class="text-sm text-text-secondary">{group.description}</p>
                {flow.length ? (
                  <p class="text-xs uppercase tracking-[0.25em] text-text-secondary/70">
                    Flow → {flow.join(' · ')}
                  </p>
                ) : null}
                <div class="flex flex-wrap gap-phi-1 text-xs">
                  {counts.current > 0 ? (
                    <span class="status-chip status-current">{counts.current} Current</span>
                  ) : null}
                  {counts.building > 0 ? (
                    <span class="status-chip status-building">{counts.building} Building</span>
                  ) : null}
                  {counts.future > 0 ? (
                    <span class="status-chip status-future">{counts.future} Future</span>
                  ) : null}
                </div>
              </div>
            );
          })()}
        </div>
      </div>
    ) : null}

    <div class="mt-phi-2 text-xs uppercase tracking-[0.25em] text-text-secondary/70">
      Flow summary: Inputs &#8594; Core &#8594; Proof &#8594; Future (modules branch from Core).
    </div>
  </div>

  <div class="space-y-phi-2">
    {orderedGroups.map((group) => {
      const groupNodes = nodesByGroup[group.id] || [];
      const counts = countStatuses(groupNodes);
      const flow = flowLabels(group);
      const isExternalOnly = groupNodes.length > 0 && groupNodes.every((node) => node.origin === 'external');
      const clusters = group.id === 'modules' ? moduleClusters : null;
      return (
        <details class="rounded-2xl border border-line/30 bg-surface-muted p-phi-2">
          <summary class="cursor-pointer list-none">
            <div class="flex flex-wrap items-start justify-between gap-phi-2">
              <div class="space-y-phi-1">
                <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{group.label}</p>
                <h3 class="text-lg font-display text-text-primary">{group.headline}</h3>
                <p class="text-sm text-text-secondary">{group.description}</p>
                {flow.length ? (
                  <p class="text-xs uppercase tracking-[0.25em] text-text-secondary/70">
                    Flow → {flow.join(' · ')}
                  </p>
                ) : null}
              </div>
              <div class="flex flex-wrap gap-phi-1 text-xs">
                {isExternalOnly ? (
                  <span class="status-chip status-external">{counts.external} External</span>
                ) : (
                  <>
                    {counts.current > 0 ? (
                      <span class="status-chip status-current">{counts.current} Current</span>
                    ) : null}
                    {counts.building > 0 ? (
                      <span class="status-chip status-building">{counts.building} Building</span>
                    ) : null}
                    {counts.future > 0 ? (
                      <span class="status-chip status-future">{counts.future} Future</span>
                    ) : null}
                  </>
                )}
                <span class="text-text-secondary/60 text-xs">Toggle details</span>
              </div>
            </div>
          </summary>
          <div class="mt-phi-2 space-y-phi-2">
            <Panel size="sm" class="space-y-phi-1">
              <p class="text-sm text-text-secondary">{group.relation}</p>
            </Panel>
            {clusters ? (
              <div class="space-y-phi-2">
                {clusters.map((cluster) => (
                  <div class="rounded-2xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{cluster.label}</p>
                    <div class="grid md:grid-cols-2 gap-phi-2">
                      {cluster.nodes.map((node) => {
                        const siteHref = node.website_path ? withBase(node.website_path) : null;
                        const docsHref = normalizeHref(node.docs_url);
                        const showSite = siteHref && siteHref !== docsHref;
                        const improves = node.improves?.slice(0, 3) || [];
                        return (
                          <div class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1 ${statusAccent(node)} ${statusOpacity(node)}`.trim()}>
                            <div class="flex items-center justify-between gap-phi-2">
                              <div class="flex items-center gap-phi-2">
                                {node.logo ? (
                                  <img
                                    src={withBase(node.logo)}
                                    alt={node.label}
                                    class="h-6 w-6 object-contain flex-shrink-0"
                                    loading="lazy"
                                  />
                                ) : (
                                  <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                                )}
                                <span class="text-sm text-text-primary font-medium">{node.label}</span>
                              </div>
                              <span class={statusClass(node)}>{statusText(node)}</span>
                            </div>

                            {node.origin === 'external' && improves.length ? (
                              <div class="space-y-phi-1">
                                <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                                <ul class="text-sm text-text-secondary space-y-phi-1">
                                  {improves.map((improvement) => {
                                    const target = improveTarget(improvement);
                                    return (
                                      <li>
                                        <span>{improvement.label}</span>
                                        {target ? (
                                          <>
                                            <span class="text-text-secondary/60"> · </span>
                                            <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                              {target.label}
                                            </a>
                                          </>
                                        ) : null}
                                      </li>
                                    );
                                  })}
                                </ul>
                              </div>
                            ) : null}

                            <p class="text-sm text-text-secondary">
                              {node.flow_note || node.summary}
                            </p>

                            <div class="flex flex-wrap gap-phi-1 text-sm">
                              {showSite ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                                  Guide
                                </a>
                              ) : null}
                              {docsHref ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                                  Docs
                                </a>
                              ) : null}
                              {node.proof ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                                  Proof ({proofStatusLabel(node.proof.status)})
                                </a>
                              ) : null}
                              {node.external_url ? (
                                <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                                  External
                                </a>
                              ) : null}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div class="grid md:grid-cols-2 gap-phi-2">
                {groupNodes.map((node) => {
                  const siteHref = node.website_path ? withBase(node.website_path) : null;
                  const docsHref = normalizeHref(node.docs_url);
                  const showSite = siteHref && siteHref !== docsHref;
                  const improves = node.improves?.slice(0, 3) || [];
                  return (
                    <div class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1 ${statusAccent(node)} ${statusOpacity(node)}`.trim()}>
                      <div class="flex items-center justify-between gap-phi-2">
                        <div class="flex items-center gap-phi-2">
                          {node.logo ? (
                            <img
                              src={withBase(node.logo)}
                              alt={node.label}
                              class="h-6 w-6 object-contain flex-shrink-0"
                              loading="lazy"
                            />
                          ) : (
                            <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                          )}
                          <span class="text-sm text-text-primary font-medium">{node.label}</span>
                        </div>
                        <span class={statusClass(node)}>{statusText(node)}</span>
                      </div>

                      {node.origin === 'external' && improves.length ? (
                        <div class="space-y-phi-1">
                          <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                          <ul class="text-sm text-text-secondary space-y-phi-1">
                            {improves.map((improvement) => {
                              const target = improveTarget(improvement);
                              return (
                                <li>
                                  <span>{improvement.label}</span>
                                  {target ? (
                                    <>
                                      <span class="text-text-secondary/60"> · </span>
                                      <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                        {target.label}
                                      </a>
                                    </>
                                  ) : null}
                                </li>
                              );
                            })}
                          </ul>
                        </div>
                      ) : null}

                      <p class="text-sm text-text-secondary">
                        {node.flow_note || node.summary}
                      </p>

                      <div class="flex flex-wrap gap-phi-1 text-sm">
                        {showSite ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                            Guide
                          </a>
                        ) : null}
                        {docsHref ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                            Docs
                          </a>
                        ) : null}
                        {node.proof ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                            Proof ({proofStatusLabel(node.proof.status)})
                          </a>
                        ) : null}
                        {node.external_url ? (
                          <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                            External
                          </a>
                        ) : null}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </details>
      );
    })}
  </div>
</div>
