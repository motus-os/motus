---
import Panel from './Panel.astro';
import { getDisplayBadge, getStatusLabel } from '../lib/status.js';

const { groups = [], nodes = [], base = '/', proofIndex = null } = Astro.props;

const orderedGroups = [...groups].sort((a, b) => (a.position ?? 0) - (b.position ?? 0));
const groupIndex = new Map(groups.map((group) => [group.id, group]));

const nodesByGroup = orderedGroups.reduce((acc, group) => {
  acc[group.id] = nodes
    .filter((node) => node.group === group.id)
    .map((node) => ({
      ...node,
      proof: proofIndex && node.proof_id ? proofIndex.get(node.proof_id) : null,
    }));
  return acc;
}, {});

const normalizedBase = base.endsWith('/') ? base : `${base}/`;
const withBase = (path) => (path ? `${normalizedBase}${path.replace(/^\/+/, '')}` : null);
const normalizeHref = (href) => {
  if (!href) return null;
  return href.startsWith('http') ? href : withBase(href);
};
const proofHref = (proof) => (proof ? `${normalizedBase}docs/evidence#claim-${proof.id}` : null);

const statusClass = (node) => getDisplayBadge({ status: node.status, origin: node.origin }).className;
const statusText = (node) => getDisplayBadge({ status: node.status, origin: node.origin }).label;
const proofStatusLabel = (status) => (status ? getStatusLabel(status) : '');
const statusOpacity = (node) => {
  if (node.status === 'future') return 'opacity-70';
  if (node.status === 'building') return 'opacity-85';
  return 'opacity-100';
};
const statusAccent = (node) => {
  if (node.origin === 'external') {
    return 'border-l-4 border-line/40';
  }
  switch (node.status) {
    case 'current':
      return 'border-l-4 border-text-secondary/70';
    case 'building':
      return 'border-l-4 border-mint/70';
    case 'future':
      return 'border-l-4 border-future/70';
    default:
      return 'border-l-4 border-line/40';
  }
};

const groupStatus = (groupId) => {
  if (groupId === 'inputs') return 'external';
  if (groupId === 'modules') return 'building';
  if (groupId === 'future') return 'future';
  return 'current';
};

const groupStatusLabel = (status) => {
  switch (status) {
    case 'building':
      return 'Building';
    case 'future':
      return 'Future';
    case 'external':
      return 'External';
    default:
      return 'Current';
  }
};

const groupStatusClass = (status) => {
  switch (status) {
    case 'building':
      return 'border-mint/60 border-dashed opacity-85';
    case 'future':
      return 'border-future/60 border-dotted opacity-60';
    case 'external':
      return 'border-line/60';
    default:
      return 'border-mint/60';
  }
};

const moduleNodes = nodesByGroup.modules || [];
const clusterOrder = [
  'Standards + Contracts',
  'Knowledge + Context',
  'Proof + Validation',
  'Runtime Control',
  'Scaffolds',
];
const moduleClusters = clusterOrder
  .map((label) => ({
    label,
    nodes: moduleNodes.filter((node) => node.cluster === label),
  }))
  .filter((cluster) => cluster.nodes.length > 0);
const clusteredIds = new Set(
  moduleClusters.flatMap((cluster) => cluster.nodes.map((node) => node.id)),
);
const ungroupedModules = moduleNodes.filter((node) => !clusteredIds.has(node.id));
if (ungroupedModules.length) {
  moduleClusters.push({ label: 'Other', nodes: ungroupedModules });
}

const improveTarget = (improvement) => {
  const targetId = (improvement.motus_nodes || [])[0];
  const target = targetId ? nodes.find((node) => node.id === targetId) : null;
  if (!target) return null;
  return {
    label: target.label,
    href: target.website_path ? withBase(target.website_path) : normalizeHref(target.docs_url),
  };
};


const railGroupIds = ['inputs', 'core', 'governance', 'future'];
const railGroups = railGroupIds
  .map((id) => orderedGroups.find((group) => group.id === id))
  .filter(Boolean);
const modulesGroup = orderedGroups.find((group) => group.id === 'modules');

---

<div class="space-y-phi-3" data-eco-root data-eco-filter="current">
  <div class="rounded-3xl border border-line/30 bg-surface-muted p-phi-2">
    <div class="space-y-phi-2">
      <div class="flex flex-wrap items-center justify-center gap-phi-2">
        {railGroups.map((group, index) => {
          const status = groupStatus(group.id);
          return (
            <div class="flex items-center gap-phi-2">
              <div class={`rounded-2xl border px-phi-2 py-phi-2 text-center space-y-phi-1 bg-surface ${groupStatusClass(status)}`.trim()}>
                <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">{group.label}</p>
                <h3 class="text-base font-display text-text-primary">{group.headline}</h3>
                <p class="text-xs text-text-secondary">{group.relation}</p>
                <span class={`status-chip status-${status}`}>{groupStatusLabel(status)}</span>
              </div>
              {index < railGroups.length - 1 ? (
                <span class="text-text-secondary/60 text-lg">&#8594;</span>
              ) : null}
            </div>
          );
        })}
      </div>

      {modulesGroup ? (
        <div class="flex flex-col items-center gap-phi-1">
          <span class="text-text-secondary/60 text-lg">&#8595;</span>
          <div class={`rounded-2xl border px-phi-2 py-phi-2 text-center space-y-phi-1 bg-surface ${groupStatusClass(groupStatus('modules'))}`.trim()}>
            <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">{modulesGroup.label}</p>
            <h3 class="text-base font-display text-text-primary">{modulesGroup.headline}</h3>
            <p class="text-xs text-text-secondary">{modulesGroup.relation}</p>
            <span class={`status-chip status-${groupStatus('modules')}`}>{groupStatusLabel(groupStatus('modules'))}</span>
          </div>
        </div>
      ) : null}

      <div class="flex flex-wrap items-center justify-between gap-phi-2 text-xs text-text-secondary/70">
        <div class="flex flex-wrap items-center gap-phi-1">
          <button
            type="button"
            data-eco-toggle="current"
            class="px-2 py-1 rounded-full border border-line/40 text-text-primary hover:text-mint transition-colors"
            aria-pressed="true"
          >
            Current only
          </button>
          <button
            type="button"
            data-eco-toggle="all"
            class="px-2 py-1 rounded-full border border-line/40 text-text-secondary hover:text-mint transition-colors"
            aria-pressed="false"
          >
            All layers
          </button>
        </div>
        <div class="flex flex-wrap items-center gap-phi-2">
          <span class="hidden md:inline">Solid = current 路 Dashed = building 路 Dotted = future</span>
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-phi-2" data-eco-detail>
    {orderedGroups.map((group) => {
      const groupNodes = nodesByGroup[group.id] || [];
      const clusters = group.id === 'modules' ? moduleClusters : null;
      return (
        <details class="rounded-2xl border border-line/30 bg-surface-muted p-phi-2">
          <summary class="cursor-pointer list-none">
            <div class="flex flex-wrap items-start justify-between gap-phi-2">
              <div class="space-y-phi-1">
                <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">{group.label}</p>
                <h3 class="text-lg font-display text-text-primary">{group.headline}</h3>
                <p class="text-sm text-text-secondary">{group.description}</p>
              </div>
              <div class="flex flex-wrap gap-phi-1 text-xs">
                <span class={`status-chip status-${groupStatus(group.id)}`}>
                  {groupStatusLabel(groupStatus(group.id))}
                </span>
              </div>
            </div>
          </summary>
          <div class="mt-phi-2 space-y-phi-2">
            <p class="text-sm text-text-secondary">{group.relation}</p>
            {clusters ? (
              <div class="space-y-phi-2">
                {clusters.map((cluster) => (
                  <div class="rounded-2xl bg-surface/70 px-phi-2 py-phi-2 space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{cluster.label}</p>
                    <div class="grid md:grid-cols-2 gap-phi-2">
                      {cluster.nodes.map((node) => {
                        const siteHref = node.website_path ? withBase(node.website_path) : null;
                        const docsHref = normalizeHref(node.docs_url);
                        const showSite = siteHref && siteHref !== docsHref;
                        const improves = node.improves?.slice(0, 2) || [];
                        return (
                          <div
                            data-node-status={node.status}
                            class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1 ${statusAccent(node)} ${statusOpacity(node)}`.trim()}
                          >
                            <div class="flex items-center justify-between gap-phi-2">
                              <div class="flex items-center gap-phi-2">
                                {node.logo ? (
                                  <img
                                    src={withBase(node.logo)}
                                    alt={node.label}
                                    class="h-6 w-6 object-contain flex-shrink-0"
                                    loading="lazy"
                                  />
                                ) : (
                                  <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                                )}
                                <span class="text-sm text-text-primary font-medium">{node.label}</span>
                              </div>
                              <span class={statusClass(node)}>{statusText(node)}</span>
                            </div>

                            {node.origin === 'external' && improves.length ? (
                              <div class="space-y-phi-1">
                                <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                                <ul class="text-sm text-text-secondary space-y-phi-1">
                                  {improves.map((improvement) => {
                                    const target = improveTarget(improvement);
                                    return (
                                      <li>
                                        <span>{improvement.label}</span>
                                        {target ? (
                                          <>
                                            <span class="text-text-secondary/60"> 路 </span>
                                            <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                              {target.label}
                                            </a>
                                          </>
                                        ) : null}
                                      </li>
                                    );
                                  })}
                                </ul>
                              </div>
                            ) : null}

                            <p class="text-sm text-text-secondary">
                              {node.origin === 'external' ? node.summary : (node.flow_note || node.summary)}
                            </p>

                            <div class="flex flex-wrap gap-phi-1 text-sm">
                              {showSite ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                                  Guide
                                </a>
                              ) : null}
                              {docsHref ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                                  Docs
                                </a>
                              ) : null}
                              {node.proof ? (
                                <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                                  Proof ({proofStatusLabel(node.proof.status)})
                                </a>
                              ) : null}
                              {node.external_url ? (
                                <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                                  External
                                </a>
                              ) : null}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div class="grid md:grid-cols-2 gap-phi-2">
                {groupNodes.map((node) => {
                  const siteHref = node.website_path ? withBase(node.website_path) : null;
                  const docsHref = normalizeHref(node.docs_url);
                  const showSite = siteHref && siteHref !== docsHref;
                  const improves = node.improves?.slice(0, 2) || [];
                  return (
                    <div
                      data-node-status={node.status}
                      class={`rounded-xl border border-line/30 bg-surface px-phi-2 py-phi-2 space-y-phi-1 ${statusAccent(node)} ${statusOpacity(node)}`.trim()}
                    >
                      <div class="flex items-center justify-between gap-phi-2">
                        <div class="flex items-center gap-phi-2">
                          {node.logo ? (
                            <img
                              src={withBase(node.logo)}
                              alt={node.label}
                              class="h-6 w-6 object-contain flex-shrink-0"
                              loading="lazy"
                            />
                          ) : (
                            <span class="h-2.5 w-2.5 rounded-full bg-mint/60"></span>
                          )}
                          <span class="text-sm text-text-primary font-medium">{node.label}</span>
                        </div>
                        <span class={statusClass(node)}>{statusText(node)}</span>
                      </div>

                      {node.origin === 'external' && improves.length ? (
                        <div class="space-y-phi-1">
                          <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Motus adds</p>
                          <ul class="text-sm text-text-secondary space-y-phi-1">
                            {improves.map((improvement) => {
                              const target = improveTarget(improvement);
                              return (
                                <li>
                                  <span>{improvement.label}</span>
                                  {target ? (
                                    <>
                                      <span class="text-text-secondary/60"> 路 </span>
                                      <a class="text-mint hover:text-text-primary transition-colors" href={target.href}>
                                        {target.label}
                                      </a>
                                    </>
                                  ) : null}
                                </li>
                              );
                            })}
                          </ul>
                        </div>
                      ) : null}

                    <p class="text-sm text-text-secondary">
                      {node.origin === 'external' ? node.summary : (node.flow_note || node.summary)}
                    </p>

                      <div class="flex flex-wrap gap-phi-1 text-sm">
                        {showSite ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={siteHref}>
                            Guide
                          </a>
                        ) : null}
                        {docsHref ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={docsHref} target="_blank" rel="noopener">
                            Docs
                          </a>
                        ) : null}
                        {node.proof ? (
                          <a class="text-mint hover:text-text-primary transition-colors" href={proofHref(node.proof)}>
                            Proof ({proofStatusLabel(node.proof.status)})
                          </a>
                        ) : null}
                        {node.external_url ? (
                          <a class="text-text-secondary hover:text-mint transition-colors" href={node.external_url} target="_blank" rel="noopener">
                            External
                          </a>
                        ) : null}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </details>
      );
    })}
  </div>
</div>

<style>
  [data-eco-root][data-eco-filter='current'] [data-node-status='building'],
  [data-eco-root][data-eco-filter='current'] [data-node-status='future'] {
    display: none;
  }

  [data-eco-toggle][aria-pressed='true'] {
    border-color: oklch(var(--mint) / 0.6);
    color: oklch(var(--text-primary));
  }
</style>

<script>
  const ecosystemRoot = document.querySelector('[data-eco-root]');
  if (ecosystemRoot) {
    const toggles = ecosystemRoot.querySelectorAll('[data-eco-toggle]');
    toggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        const filter = toggle.getAttribute('data-eco-toggle');
        if (!filter) return;
        ecosystemRoot.setAttribute('data-eco-filter', filter);
        toggles.forEach((btn) => {
          const active = btn === toggle;
          btn.setAttribute('aria-pressed', active ? 'true' : 'false');
          btn.classList.toggle('text-text-primary', active);
          btn.classList.toggle('text-text-secondary', !active);
        });
      });
    });
  }
</script>
