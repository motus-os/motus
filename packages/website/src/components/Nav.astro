---
const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const navItems = [
  { href: `${base}`, label: 'Home' },
  { href: `${base}implementation#quickstart`, label: 'Quickstart' },
  { href: `${base}how-it-works`, label: 'How It Works' },
  { href: `${base}gates`, label: 'Evidence & Gates' },
  { href: `${base}ecosystem`, label: 'Ecosystem' },
  { href: `${base}implementation`, label: 'Implementation' },
  { href: `${base}strategies`, label: 'Strategies' },
  { href: `${base}open-source`, label: 'Source Available' },
];

const currentPath = Astro.url.pathname;
---

<nav class="border-b border-line/10 relative bg-charcoal/85 backdrop-blur-md">
  <div class="max-w-6xl mx-auto px-6 md:px-10 py-phi-2 flex items-center justify-between">
    <a href={base} class="flex items-center gap-3 hover:opacity-80 transition-opacity">
      <span class="flex items-center">
        <svg
          viewBox="0 0 375 375"
          role="img"
          aria-label="Motus"
          class="w-8 h-8 text-mint"
        >
          <path
            d="M 249.890625 -266.328125 L 342.46875 -266.328125 L 342.46875 0 L 284.09375 0 L 284.09375 -207.953125 L 282.421875 -207.953125 L 213.5 0 L 160.5 0 L 91.734375 -207.953125 L 89.890625 -207.953125 L 89.890625 0 L 31.53125 0 L 31.53125 -266.328125 L 124.109375 -266.328125 L 187 -75.46875 Z M 249.890625 -266.328125"
            transform="translate(-28.866772 315.431495)"
            fill="currentColor"
          />
        </svg>
      </span>
      <span class="text-lg md:text-xl font-display font-semibold text-text-primary">Motus</span>
    </a>

    <!-- Desktop nav (hidden on mobile) -->
    <ul class="hidden md:flex gap-8">
      {navItems.map((item) => (
        <li>
          <a
            href={item.href}
            class:list={[
              'text-xs uppercase tracking-[0.18em] transition-colors',
              currentPath === item.href
                ? 'text-mint'
                : 'text-text-secondary hover:text-mint',
            ]}
          >
            {item.label}
          </a>
        </li>
      ))}
    </ul>

    <!-- Mobile hamburger button (visible on mobile only) -->
    <button
      id="mobile-menu-button"
      class="md:hidden flex flex-col justify-center items-center w-8 h-8 gap-1.5"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <span class="hamburger-line block w-6 h-0.5 bg-text-primary transition-all duration-300"></span>
      <span class="hamburger-line block w-6 h-0.5 bg-text-primary transition-all duration-300"></span>
      <span class="hamburger-line block w-6 h-0.5 bg-text-primary transition-all duration-300"></span>
    </button>
  </div>

  <!-- Mobile menu (hidden by default) -->
  <div
    id="mobile-menu"
    class="hidden md:hidden absolute top-full left-0 right-0 bg-surface/95 border-b border-line/10 z-50"
  >
    <ul class="flex flex-col px-6 py-4 gap-4">
      {navItems.map((item) => (
        <li>
          <a
            href={item.href}
            class:list={[
              'block text-sm py-2 uppercase tracking-[0.18em] transition-colors',
              currentPath === item.href
                ? 'text-mint'
                : 'text-text-secondary hover:text-mint',
            ]}
          >
            {item.label}
          </a>
        </li>
      ))}
    </ul>
  </div>
</nav>

<script>
  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');

    if (!button || !menu) return;

    const lines = button.querySelectorAll('.hamburger-line');

    function toggleMenu() {
      const isOpen = menu.classList.contains('hidden');

      if (isOpen) {
        // Open menu
        menu.classList.remove('hidden');
        button.setAttribute('aria-expanded', 'true');

        // Animate hamburger to X
        if (lines.length === 3) {
          lines[0].classList.add('rotate-45', 'translate-y-2');
          lines[1].classList.add('opacity-0');
          lines[2].classList.add('-rotate-45', '-translate-y-2');
        }
      } else {
        // Close menu
        menu.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');

        // Reset hamburger lines
        if (lines.length === 3) {
          lines[0].classList.remove('rotate-45', 'translate-y-2');
          lines[1].classList.remove('opacity-0');
          lines[2].classList.remove('-rotate-45', '-translate-y-2');
        }
      }
    }

    function closeMenu() {
      menu.classList.add('hidden');
      button.setAttribute('aria-expanded', 'false');

      if (lines.length === 3) {
        lines[0].classList.remove('rotate-45', 'translate-y-2');
        lines[1].classList.remove('opacity-0');
        lines[2].classList.remove('-rotate-45', '-translate-y-2');
      }
    }

    // Toggle on button click
    button.addEventListener('click', toggleMenu);

    // Close menu when a link is clicked
    const menuLinks = menu.querySelectorAll('a');
    menuLinks.forEach(link => {
      link.addEventListener('click', closeMenu);
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
        closeMenu();
      }
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (!button.contains(target) && !menu.contains(target) && !menu.classList.contains('hidden')) {
        closeMenu();
      }
    });
  }

  // Initialize on page load and after Astro navigation
  initMobileMenu();
  document.addEventListener('astro:after-swap', initMobileMenu);
</script>
