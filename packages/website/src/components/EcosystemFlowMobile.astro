---
import Panel from './Panel.astro';
import { getDisplayBadge, getStatusLabel } from '../lib/status.js';

const { groups = [], nodes = [], base = '/', proofIndex } = Astro.props;

const orderedGroups = [...groups].sort((a, b) => (a.position ?? 0) - (b.position ?? 0));
const groupIndex = new Map(groups.map((group) => [group.id, group]));
const nodesByGroup = orderedGroups.reduce((acc, group) => {
  acc[group.id] = nodes
    .filter((node) => node.group === group.id)
    .map((node) => ({
      ...node,
      proof: proofIndex && node.proof_id ? proofIndex.get(node.proof_id) : null,
    }));
  return acc;
}, {});

const normalizedBase = base.endsWith('/') ? base : `${base}/`;
const withBase = (path) => (path ? `${normalizedBase}${path.replace(/^\/+/, '')}` : null);
const normalizeHref = (href) => {
  if (!href) return null;
  return href.startsWith('http') ? href : withBase(href);
};
const proofHref = (proof) => (proof ? `${normalizedBase}docs/evidence#claim-${proof.id}` : null);

const statusClass = (node) => getDisplayBadge({ status: node.status, origin: node.origin, kind: 'badge' }).className;
const statusText = (node) => getDisplayBadge({ status: node.status, origin: node.origin, kind: 'badge' }).label;
const proofStatusLabel = (status) => (status ? getStatusLabel(status) : '');

const countStatuses = (groupNodes) => {
  const counts = { current: 0, building: 0, future: 0, external: 0 };
  groupNodes.forEach((node) => {
    if (node.origin === 'external') counts.external += 1;
    if (counts[node.status] !== undefined) counts[node.status] += 1;
  });
  return counts;
};

const flowLabels = (group) =>
  (group.flow_to || [])
    .map((targetId) => groupIndex.get(targetId)?.label)
    .filter(Boolean);
---

<div class="space-y-phi-2" data-eco-root data-eco-filter="current">
  <Panel size="sm" class="space-y-phi-1">
    <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Flow</p>
    <p class="text-sm text-text-secondary">
      Inputs &#8594; Core &#8594; Proof &#8594; Future. Modules branch from Core.
    </p>
    <div class="flex flex-wrap items-center gap-phi-1 text-xs text-text-secondary/70">
      <button
        type="button"
        data-eco-toggle="current"
        class="px-2 py-1 rounded-full border border-line/40 text-text-primary"
        aria-pressed="true"
      >
        Current only
      </button>
      <button
        type="button"
        data-eco-toggle="all"
        class="px-2 py-1 rounded-full border border-line/40 text-text-secondary"
        aria-pressed="false"
      >
        All layers
      </button>
    </div>
  </Panel>

  {orderedGroups.map((group) => {
    const groupNodes = nodesByGroup[group.id] || [];
    const counts = countStatuses(groupNodes);
    const flow = flowLabels(group);
    const isExternalOnly = groupNodes.length > 0 && groupNodes.every((node) => node.origin === 'external');
    return (
      <details class="rounded-2xl border border-line/30 bg-surface-muted p-phi-2">
        <summary class="cursor-pointer list-none space-y-phi-1">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{group.label}</p>
          <h3 class="text-lg font-display text-text-primary">{group.headline}</h3>
          <p class="text-sm text-text-secondary">{group.description}</p>
          {flow.length ? (
            <p class="text-xs uppercase tracking-[0.25em] text-text-secondary/70">
              Flow &#8594; {flow.join(' Â· ')}
            </p>
          ) : null}
          <div class="flex flex-wrap gap-phi-1 text-xs">
            {isExternalOnly ? (
              <span class="status-chip status-external">{counts.external} External</span>
            ) : (
              <>
                {counts.current > 0 ? (
                  <span class="status-chip status-current">{counts.current} Current</span>
                ) : null}
                {counts.building > 0 ? (
                  <span class="status-chip status-building">{counts.building} Building</span>
                ) : null}
                {counts.future > 0 ? (
                  <span class="status-chip status-future">{counts.future} Future</span>
                ) : null}
              </>
            )}
            <span class="text-text-secondary/60 text-xs">Toggle details</span>
          </div>
        </summary>
        <div class="mt-phi-2 space-y-phi-2">
          <Panel size="sm" class="text-sm text-text-secondary">
            {group.relation}
          </Panel>
          <div class="grid gap-phi-2">
            {groupNodes.map((node) => {
              const siteHref = node.website_path ? withBase(node.website_path) : null;
              const docsHref = normalizeHref(node.docs_url);
              const showSite = siteHref && siteHref !== docsHref;
              return (
                <Panel size="sm" class="space-y-phi-1" data-node-status={node.status}>
                  <div class="flex items-center justify-between gap-phi-2">
                    <div class="flex items-center gap-phi-2">
                      {node.logo ? (
                        <img
                          src={withBase(node.logo)}
                          alt={`${node.label} logo`}
                          class="h-5 w-5 object-contain"
                          loading="lazy"
                        />
                      ) : null}
                      <h4 class="text-base font-display text-text-primary">{node.label}</h4>
                    </div>
                    <span class={statusClass(node)}>{statusText(node)}</span>
                  </div>
                  {node.origin === 'external' && node.improves?.length ? (
                    <div class="space-y-phi-1 text-sm text-text-secondary">
                      <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Motus adds</p>
                      <ul class="space-y-phi-1">
                        {node.improves.slice(0, 3).map((improve) => (
                          <li>{improve.label}</li>
                        ))}
                      </ul>
                    </div>
                  ) : null}
                  <p class="text-sm text-text-secondary">{node.flow_note || node.summary}</p>
                  <div class="flex flex-wrap gap-phi-2 text-sm">
                    {showSite ? (
                      <a href={siteHref} class="text-mint hover:text-text-primary transition-colors">
                        Guide &#8594;
                      </a>
                    ) : null}
                    {docsHref ? (
                      <a href={docsHref} class="text-mint hover:text-text-primary transition-colors">
                        Docs &#8594;
                      </a>
                    ) : null}
                    {node.proof ? (
                      <a href={proofHref(node.proof)} class="text-mint hover:text-text-primary transition-colors">
                        Proof ({proofStatusLabel(node.proof.status)}) &#8594;
                      </a>
                    ) : null}
                    {node.external_url ? (
                      <a href={node.external_url} target="_blank" rel="noopener" class="text-text-secondary hover:text-mint transition-colors">
                        External &#8594;
                      </a>
                    ) : null}
                  </div>
                </Panel>
              );
            })}
          </div>
        </div>
      </details>
    );
  })}
</div>

<style>
  [data-eco-root][data-eco-filter='current'] [data-node-status='building'],
  [data-eco-root][data-eco-filter='current'] [data-node-status='future'] {
    display: none;
  }

  [data-eco-toggle][aria-pressed='true'] {
    border-color: oklch(var(--mint) / 0.6);
    color: oklch(var(--text-primary));
  }
</style>

<script>
  const ecosystemRoot = document.querySelector('[data-eco-root]');
  if (ecosystemRoot) {
    const toggles = ecosystemRoot.querySelectorAll('[data-eco-toggle]');
    toggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        const filter = toggle.getAttribute('data-eco-toggle');
        if (!filter) return;
        ecosystemRoot.setAttribute('data-eco-filter', filter);
        toggles.forEach((btn) => {
          const active = btn === toggle;
          btn.setAttribute('aria-pressed', active ? 'true' : 'false');
          btn.classList.toggle('text-text-primary', active);
          btn.classList.toggle('text-text-secondary', !active);
        });
      });
    });
  }
</script>
