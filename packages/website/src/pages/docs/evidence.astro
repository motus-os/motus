---
import Layout from '../../layouts/Layout.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Panel from '../../components/Panel.astro';
import DocsWayfinding from '../../components/DocsWayfinding.astro';
import proofLedger from '../../data/proof-ledger.json';
import { getStatusClass, getStatusLabel } from '../../lib/status.js';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
const resolveUrl = (url) => (url.startsWith('http') ? url : `${base}${url.replace(/^\/+/, '')}`);

const seen = new Set();
for (const claim of proofLedger.claims) {
  if (seen.has(claim.id)) {
    throw new Error(`Duplicate claim id in proof ledger: ${claim.id}`);
  }
  seen.add(claim.id);
}

const statusLabel = (status) => getStatusLabel(status);
const statusClass = (status) => getStatusClass(status, 'badge');
---

<Layout title="Evidence Registry">
  <Section tone="dark" pad="hero" class="text-center" innerClass="max-w-3xl">
    <SectionHeader
      eyebrow="Evidence Registry"
      subtitle="Every claim on the site links to a proof artifact. This registry is the canonical index."
      size="xl"
    >
      <span slot="title">Proof-first by default.</span>
    </SectionHeader>
    <div class="mt-phi-3 flex flex-wrap justify-center gap-phi-2 text-sm">
      <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">Implementation guide</a>
      <a href={`${base}docs/ecosystem`} class="text-mint hover:text-text-primary transition-colors">Ecosystem map</a>
      <a href={`${base}open-source`} class="text-mint hover:text-text-primary transition-colors">Source available</a>
    </div>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <Panel size="sm" class="flex flex-col md:flex-row md:items-center md:justify-between gap-phi-2">
      <div class="space-y-phi-1">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Looking for gates?</p>
        <p class="text-sm text-text-secondary">
          Policy, evidence, and completion gates live in the dedicated gates guide.
        </p>
      </div>
      <a href={`${base}docs/gates`} class="text-mint hover:text-text-primary transition-colors">
        Open the Gates Guide &#8594;
      </a>
    </Panel>
  </Section>

  <Section tone="light">
    <SectionHeader
      eyebrow="Claims"
      subtitle="Lead with the result, then the proof. Future claims show what is being built."
      align="left"
      size="md"
      class="mb-phi-4"
      maxWidth="max-w-3xl"
    />
    <div class="space-y-phi-3">
      {proofLedger.claims.map((claim) => (
        <div id={`claim-${claim.id}`} class="scroll-mt-24">
          <Panel class="space-y-phi-2">
            <div class="flex flex-wrap items-center justify-between gap-phi-2">
              <span class={statusClass(claim.status)}>{statusLabel(claim.status)}</span>
              {claim.verified_on ? (
                <span class="text-xs uppercase tracking-[0.2em] text-text-secondary">
                  Recorded {claim.verified_on}
                </span>
              ) : null}
            </div>
            <div class="space-y-phi-2">
              <div class="space-y-phi-1">
                <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Impact</p>
                <p class="text-xl md:text-2xl font-display text-text-primary">{claim.impact}</p>
              </div>
              <div class="space-y-phi-1">
                <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">How it works</p>
                <p class="text-sm text-text-secondary">{claim.claim}</p>
              </div>
              <div class="space-y-phi-1">
                <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Method</p>
                <p class="text-sm text-text-secondary">{claim.method}</p>
              </div>
            </div>
            <div class="space-y-phi-1 text-sm">
              {claim.evidence.map((item) => (
                <a
                  href={resolveUrl(item.url)}
                  target="_blank"
                  rel="noopener"
                  class="block text-mint hover:text-text-primary transition-colors"
                >
                  {item.label} &#8594;
                </a>
              ))}
            </div>
          </Panel>
        </div>
      ))}
    </div>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <DocsWayfinding pageId="evidence" base={base} />
  </Section>
</Layout>
