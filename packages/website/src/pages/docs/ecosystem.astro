---
import Layout from '../../layouts/Layout.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Panel from '../../components/Panel.astro';
import EcosystemFlow from '../../components/EcosystemFlow.astro';
import EcosystemFlowMobile from '../../components/EcosystemFlowMobile.astro';

import ecosystemMap from '../../data/ecosystem-map.json';
import proofLedger from '../../data/proof-ledger.json';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const groups = ecosystemMap.groups || [];
const nodes = ecosystemMap.nodes || [];
const proofIndex = new Map((proofLedger.claims || []).map((claim) => [claim.id, claim]));
const missingProof = nodes
  .filter((node) => node.proof_id && !proofIndex.has(node.proof_id))
  .map((node) => node.proof_id);

if (missingProof.length > 0) {
  throw new Error(`Ecosystem map references missing proof entries: ${missingProof.join(', ')}`);
}
---

<Layout title="Ecosystem Map - Motus">
  <Section tone="dark" pad="none" class="text-center py-phi-2 md:py-phi-3" innerClass="max-w-3xl">
    <SectionHeader
      eyebrow="Ecosystem Blueprint"
      title="The finished system, mapped in one view"
      subtitle="See what ships now, what is building, and what is next. Status chips show the difference."
      as="h1"
      size="md"
      titleClassName="text-3xl md:text-4xl"
      subtitleClassName="text-sm md:text-base"
    />
  </Section>

  <Section tone="light" pad="none" class="border-t border-line/20 px-6 md:px-10 py-phi-2 md:py-phi-3">
    <div class="flex flex-wrap items-center gap-phi-2 text-xs mb-phi-2">
      <span class="status-chip status-current">Current</span>
      <span class="status-chip status-building">Building</span>
      <span class="status-chip status-future">Future</span>
      <span class="status-chip status-external">External</span>
    </div>
    <div class="max-w-6xl mx-auto">
      <div class="md:hidden">
        <EcosystemFlowMobile groups={groups} nodes={nodes} base={base} proofIndex={proofIndex} />
      </div>
      <div class="hidden md:block">
        <EcosystemFlow groups={groups} nodes={nodes} base={base} proofIndex={proofIndex} />
      </div>
    </div>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/20" innerClass="max-w-5xl">
    <Panel size="sm" class="space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.3em] text-text-secondary">How to read the map</p>
      <div class="space-y-phi-2 text-sm text-text-secondary">
        <div class="space-y-phi-1">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Result</p>
          <p>Know what is real now, in flight, or directional in one view.</p>
        </div>
        <div class="space-y-phi-1">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">How to read it</p>
          <ul class="space-y-phi-1">
            <li>- Motus Core is centered; inputs, modules, governance, and future layers fan out.</li>
            <li>- The “Motus adds” line shows the lift per integration.</li>
            <li>- Status chips mark current, building, future, and external.</li>
          </ul>
        </div>
        <div class="space-y-phi-1">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Proof</p>
          <p>Nodes link to evidence or roadmap status. Future items are labeled and never implied as shipped.</p>
        </div>
      </div>
    </Panel>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/20" innerClass="max-w-5xl">
    <SectionHeader
      eyebrow="Implementation Path"
      title="Build the ecosystem in phases"
      subtitle="Scale without drift: kernel → governance → modules with exit criteria."
      class="mb-phi-3"
      maxWidth="max-w-3xl"
    />
    <div class="grid md:grid-cols-3 gap-phi-2">
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 1</p>
        <h3 class="text-lg font-display text-text-primary">Kernel Foundation</h3>
        <p class="text-sm text-text-secondary">Lease closes with outcome, evidence, and decision.</p>
        <p class="text-sm text-text-secondary">Coordination DB + six-call loop.</p>
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
        <ul class="text-sm text-text-secondary space-y-phi-1">
          <li>- Lease released with outcome</li>
          <li>- Evidence + decision logged</li>
          <li>- Status visible via <span class="text-text-primary">motus work status</span></li>
        </ul>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 2</p>
        <h3 class="text-lg font-display text-text-primary">Governance + Evidence</h3>
        <p class="text-sm text-text-secondary">Audit trail is complete before completion.</p>
        <p class="text-sm text-text-secondary">Evidence bundles + decision log + policy gates.</p>
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
        <ul class="text-sm text-text-secondary space-y-phi-1">
          <li>- Evidence bundles are stored</li>
          <li>- Decision log is populated</li>
          <li>- Policy gates are satisfied</li>
        </ul>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 3</p>
        <h3 class="text-lg font-display text-text-primary">Bundled Modules</h3>
        <p class="text-sm text-text-secondary">Capabilities scale without breaking invariants.</p>
        <p class="text-sm text-text-secondary">Module registry + dependency checks.</p>
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
        <ul class="text-sm text-text-secondary space-y-phi-1">
          <li>- Module dependencies satisfied</li>
          <li>- Registry status matches release</li>
          <li>- Module docs + tests exist</li>
        </ul>
      </Panel>
    </div>
    <div class="mt-phi-3 flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
      <span>Need the step-by-step commands?</span>
      <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">
        Open the Implementation Guide &#8594;
      </a>
    </div>
    <Panel size="sm" class="mt-phi-3 space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Future</p>
      <div class="flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
        <span class="text-text-primary">Signed work receipts</span>
        <span class="text-text-secondary/60">&#8594;</span>
        <span class="text-text-primary">Asset registry</span>
        <span class="text-text-secondary/60">&#8594;</span>
        <span class="text-text-primary">Motus Exchange</span>
      </div>
      <p class="text-text-secondary text-sm">These layers remain future until verified and promoted in the registry.</p>
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">
          See future module definitions &#8594;
        </a>
      </div>
    </Panel>
  </Section>
</Layout>
