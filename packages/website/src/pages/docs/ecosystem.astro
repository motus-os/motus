---
import Layout from '../../layouts/Layout.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Panel from '../../components/Panel.astro';
import EcosystemFlow from '../../components/EcosystemFlow.astro';
import EcosystemFlowMobile from '../../components/EcosystemFlowMobile.astro';
import DocsWayfinding from '../../components/DocsWayfinding.astro';

import ecosystemMap from '../../data/ecosystem-map.json';
import proofLedger from '../../data/proof-ledger.json';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const groups = ecosystemMap.groups || [];
const nodes = ecosystemMap.nodes || [];
const proofIndex = new Map((proofLedger.claims || []).map((claim) => [claim.id, claim]));
const missingProof = nodes
  .filter((node) => node.proof_id && !proofIndex.has(node.proof_id))
  .map((node) => node.proof_id);

if (missingProof.length > 0) {
  throw new Error(`Ecosystem map references missing proof entries: ${missingProof.join(', ')}`);
}
---

<Layout title="Ecosystem Map - Motus">
  <Section tone="dark" pad="none" class="text-center py-phi-2 md:py-phi-3" innerClass="max-w-3xl">
    <SectionHeader
      eyebrow="Ecosystem Blueprint"
      title="The finished system, mapped in one view"
      subtitle="Follow the flow at a glance, then open each lane for details. Status chips show what is current, building, and future."
      as="h1"
      size="md"
      titleClassName="text-3xl md:text-4xl"
      subtitleClassName="text-sm md:text-base"
    />
  </Section>

  <Section tone="light" pad="none" class="border-t border-line/30 px-6 md:px-10 py-phi-2 md:py-phi-3">
    <div class="flex flex-wrap items-center gap-phi-2 text-xs mb-phi-2">
      <span class="status-chip status-current">Current</span>
      <span class="status-chip status-building">Building</span>
      <span class="status-chip status-future">Future</span>
      <span class="status-chip status-external">External</span>
    </div>
    <p class="text-xs text-text-secondary/70 mb-phi-2">
      Current is released. Building is the next 3 releases. Future is beyond.
    </p>
    <Panel size="sm" class="mb-phi-3 flex flex-col md:flex-row md:items-center md:justify-between gap-phi-2">
      <div class="space-y-phi-1">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Canonical map</p>
        <p class="text-sm text-text-secondary">
          The authoritative ecosystem map lives in GitHub. This view stays in sync.
        </p>
      </div>
      <a
        href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/website/ecosystem-map.yaml"
        class="text-mint hover:text-text-primary transition-colors text-sm"
        target="_blank"
        rel="noopener"
      >
        Open ecosystem map &#8594;
      </a>
    </Panel>
    <div class="max-w-6xl mx-auto">
      <div class="md:hidden">
        <EcosystemFlowMobile groups={groups} nodes={nodes} base={base} proofIndex={proofIndex} />
      </div>
      <div class="hidden md:block">
        <EcosystemFlow groups={groups} nodes={nodes} base={base} proofIndex={proofIndex} />
      </div>
    </div>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/30" innerClass="max-w-5xl">
    <Panel size="sm" class="space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.3em] text-text-secondary">How to read the map</p>
      <div class="space-y-phi-2 text-sm text-text-secondary">
        <div class="space-y-phi-1">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Overview</p>
          <p>See how inputs flow into the core, proof, and future economy.</p>
        </div>
        <div class="space-y-phi-1">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Navigate</p>
          <ul class="space-y-phi-1">
            <li>- Open a lane to explore modules, integrations, and proofs.</li>
            <li>- Status chips mark current, building, future, and external.</li>
          </ul>
        </div>
        <div class="space-y-phi-1">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Evidence</p>
          <p>Nodes link to evidence or roadmap status. Future items are labeled and never implied as shipped.</p>
        </div>
      </div>
    </Panel>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/30" innerClass="max-w-5xl">
    <SectionHeader
      eyebrow="Implementation Path"
      title="Build the ecosystem in phases"
      subtitle="Kernel → governance → modules. Full exit criteria live in the implementation guide."
      class="mb-phi-3"
      maxWidth="max-w-3xl"
    />
    <div class="grid md:grid-cols-3 gap-phi-2">
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 1</p>
        <h3 class="text-lg font-display text-text-primary">Kernel Foundation</h3>
        <p class="text-sm text-text-secondary">Six-call loop, coordination DB, and receipts.</p>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 2</p>
        <h3 class="text-lg font-display text-text-primary">Governance + Evidence</h3>
        <p class="text-sm text-text-secondary">Evidence bundles, decision log, and gates.</p>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 3</p>
        <h3 class="text-lg font-display text-text-primary">Bundled Modules</h3>
        <p class="text-sm text-text-secondary">Module registry, dependencies, and scale-up.</p>
      </Panel>
    </div>
    <div class="mt-phi-3 flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
      <span>Need exit criteria and commands?</span>
      <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">
        Open the Implementation Guide &#8594;
      </a>
    </div>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <DocsWayfinding pageId="ecosystem" base={base} />
  </Section>
</Layout>
