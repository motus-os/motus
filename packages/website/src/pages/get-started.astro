---
/**
 * Get Started - Build with Receipts Tutorial
 *
 * Consumes tutorial.yaml as source of truth.
 * All commands validated against motusos CLI.
 */
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import SectionHeader from '../components/SectionHeader.astro';
import Panel from '../components/Panel.astro';
import InstallCommand from '../components/InstallCommand.astro';
import Button from '../components/Button.astro';
import messaging from '../data/messaging.json';

import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load tutorial.yaml
const tutorialPath = path.join(process.cwd(), 'src/data/tutorial.yaml');
const tutorialContent = fs.readFileSync(tutorialPath, 'utf-8');
const tutorial = yaml.load(tutorialContent) as any;

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const meta = tutorial.meta;
const hero = meta.hero;
const prerequisites = tutorial.prerequisites || [];
const setup = tutorial.setup;
const quickstart = messaging.quickstart?.steps || [];
const nextSteps = tutorial.next_steps || [];

---

<Layout title="Get Started - Motus">
  <!-- Hero Section -->
  <Section tone="dark" pad="hero" class="text-center" innerClass="max-w-3xl">
    {hero.pain && (
      <p class="text-text-secondary mb-phi-2">{hero.pain}</p>
    )}
    <SectionHeader
      eyebrow="Get Started"
      title={hero.headline}
      subtitle={hero.subheadline}
      size="xl"
    />
    <div class="mt-phi-3 flex flex-col items-center gap-phi-3">
      <InstallCommand />
      <Button href={hero.cta_anchor || '#setup'} variant="secondary" size="sm">
        {hero.cta_text} &#8594;
      </Button>
    </div>
    <p class="mt-phi-4 text-sm text-text-secondary">
      Duration: ~{meta.duration_minutes} minutes
    </p>
  </Section>

  <!-- Prerequisites (if any fail, show them) -->
  <Section tone="light" pad="slim" class="border-t border-line/30" innerClass="max-w-4xl">
    <details class="group">
      <summary class="cursor-pointer text-base text-text-secondary hover:text-text-primary transition-colors">
        <span class="group-open:hidden">Show prerequisites</span>
        <span class="hidden group-open:inline">Hide prerequisites</span>
      </summary>
      <div class="mt-phi-2 grid md:grid-cols-3 gap-phi-2">
        {prerequisites.map((prereq: any) => (
          <Panel size="sm" class="space-y-phi-1">
            <p class="text-sm font-medium text-text-primary">{prereq.label}</p>
            <code class="text-sm text-mint font-mono">{prereq.check_command}</code>
            {prereq.install_url && (
              <a href={prereq.install_url} class="text-sm text-mint hover:text-text-primary transition-colors" target="_blank" rel="noopener">
                Install &#8594;
              </a>
            )}
          </Panel>
        ))}
      </div>
    </details>
  </Section>

  <!-- Setup Section (collapsed by default) -->
  <Section id="setup" tone="light" pad="slim" class="border-t border-line/30 scroll-mt-24" innerClass="max-w-4xl">
    <details class="group" open={!setup.collapsed_by_default}>
      <summary class="cursor-pointer text-base text-text-primary">
        <SectionHeader
          eyebrow="Step 00"
          title={setup.title}
          subtitle="One-time setup. Skip if already installed."
          align="left"
          size="md"
          maxWidth="max-w-3xl"
        />
      </summary>
      <div class="mt-phi-3 space-y-phi-2">
        {setup.steps.map((step: any, index: number) => (
          <Panel size="sm" class="space-y-phi-2">
            <div class="flex items-center justify-between">
              <p class="text-sm uppercase tracking-[0.25em] text-text-secondary">
                {step.title}
              </p>
            </div>
            {step.type === 'command' && (
              <code class="text-mint font-mono text-sm block bg-surface-muted p-phi-2 rounded-lg">
                {step.command}
              </code>
            )}
            {step.expected_pattern && (
              <p class="text-sm text-text-secondary">
                Expected: pattern matching <code class="text-mint">{step.expected_pattern}</code>
              </p>
            )}
          </Panel>
        ))}
      </div>
      {setup.reset_instructions && (
        <Panel size="sm" class="mt-phi-3 space-y-phi-1 border-amber-500/30 border">
          <p class="text-sm uppercase tracking-[0.25em] text-amber-400">If something goes wrong</p>
          <pre class="text-sm text-text-secondary whitespace-pre-wrap">{setup.reset_instructions}</pre>
        </Panel>
      )}
    </details>
  </Section>

  <!-- Quick Loop -->
  <Section tone="light" pad="tight" class="border-t border-line/30" innerClass="max-w-5xl">
    <SectionHeader
      eyebrow="Quick Loop"
      title="Claim. Prove. Release."
      subtitle="Three commands. One receipt."
      align="left"
      size="md"
      maxWidth="max-w-3xl"
      class="mb-phi-4"
    />
    <div class="grid md:grid-cols-3 gap-phi-3">
      {quickstart.map((step: any) => (
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">{step.title}</p>
          <code class="text-mint font-mono text-sm block bg-surface-muted p-phi-2 rounded-lg">
            {step.command}
          </code>
          {step.expected && (
            <p class="text-sm text-text-secondary">Expected: {step.expected}</p>
          )}
        </Panel>
      ))}
    </div>
  </Section>

  <!-- Full Walkthrough -->
  <Section tone="light" pad="tight" class="border-t border-line/30" innerClass="max-w-4xl">
    <SectionHeader
      eyebrow="Full Walkthrough"
      title="Canonical tutorial lives in GitHub"
      subtitle="This page stays lightweight. The full build script and assets are source-tracked."
      align="left"
      size="md"
      maxWidth="max-w-3xl"
      class="mb-phi-4"
    />
    <Panel size="sm" class="space-y-phi-2">
      <p class="text-sm text-text-secondary">
        Validated against {tutorial.validated_against} on {tutorial.last_validated}.
      </p>
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <a
          href="https://github.com/motus-os/motus/blob/main/packages/website/src/data/tutorial.yaml"
          class="text-mint hover:text-text-primary transition-colors"
          target="_blank"
          rel="noopener"
        >
          Tutorial spec &#8594;
        </a>
        <a
          href="https://github.com/motus-os/motus-demo-app"
          class="text-mint hover:text-text-primary transition-colors"
          target="_blank"
          rel="noopener"
        >
          Demo repo &#8594;
        </a>
      </div>
    </Panel>
  </Section>

  <!-- Next Steps -->
  <Section tone="light" pad="tight" innerClass="max-w-4xl text-center">
    <SectionHeader
      title="What's next?"
      subtitle="Continue your journey with these resources."
      size="md"
      class="mb-phi-3"
    />
    <div class="flex flex-wrap justify-center gap-phi-3 text-sm">
      {nextSteps.map((step: any) => (
        <a
          href={step.href.startsWith('/') ? `${base}${step.href.slice(1)}` : step.href}
          class="text-mint hover:text-text-primary transition-colors"
        >
          {step.label} &#8594;
        </a>
      ))}
    </div>
  </Section>
</Layout>
