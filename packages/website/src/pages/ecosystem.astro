---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import SectionHeader from '../components/SectionHeader.astro';
import Panel from '../components/Panel.astro';
import EcosystemFlow from '../components/EcosystemFlow.astro';
import EcosystemFlowMobile from '../components/EcosystemFlowMobile.astro';

import ecosystemMap from '../data/ecosystem-map.json';
import proofLedger from '../data/proof-ledger.json';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const groups = ecosystemMap.groups || [];
const nodes = ecosystemMap.nodes || [];
const proofIndex = new Map((proofLedger.claims || []).map((claim) => [claim.id, claim]));
const missingProof = nodes
  .filter((node) => node.proof_id && !proofIndex.has(node.proof_id))
  .map((node) => node.proof_id);

if (missingProof.length > 0) {
  throw new Error(`Ecosystem map references missing proof entries: ${missingProof.join(', ')}`);
}
---

<Layout title="Ecosystem Map - Motus">
  <Section tone="dark" pad="none" class="text-center py-phi-3 md:py-phi-4" innerClass="max-w-3xl">
    <SectionHeader
      eyebrow="Ecosystem Blueprint"
      title="The finished system, mapped in one view"
      subtitle="Motus Core is the center. Colors show what is current, building, and future."
      as="h1"
      size="md"
      titleClassName="text-3xl md:text-4xl"
      subtitleClassName="text-sm md:text-base"
    />
  </Section>

  <Section tone="light" pad="slim" class="border-t border-line/10">
    <div class="flex flex-wrap items-center gap-phi-2 text-xs mb-phi-2">
      <span class="status-chip status-current">Current</span>
      <span class="status-chip status-building">Building</span>
      <span class="status-chip status-future">Future</span>
      <span class="status-chip status-external">External</span>
    </div>
    <div class="max-w-6xl mx-auto">
      <div class="md:hidden">
        <EcosystemFlowMobile groups={groups} nodes={nodes} base={base} proofIndex={proofIndex} />
      </div>
      <div class="hidden md:block">
        <EcosystemFlow groups={groups} nodes={nodes} base={base} proofIndex={proofIndex} />
      </div>
    </div>
    <Panel size="sm" class="mt-phi-4 space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.3em] text-text-secondary">How to read the map</p>
      <ul class="space-y-phi-1 text-sm text-text-secondary">
        <li>- Motus Core sits at the center of the ecosystem.</li>
        <li>- Inputs are external systems Motus upgrades (logos).</li>
        <li>- Modules extend the core without breaking invariants.</li>
        <li>- Governance wraps execution and records proof.</li>
        <li>- Future economy builds on signed, verifiable work.</li>
      </ul>
      <p class="text-sm text-text-secondary">
        The “Motus adds” line shows the 1+1=3 effect for each integration.
      </p>
    </Panel>
    <p class="text-xs text-text-secondary mt-phi-2 max-w-3xl">
      Current items are shipped and verifiable. Building items are in flight with active roadmap IDs. Future items are directional and explicitly labeled.
    </p>
    <p class="text-sm text-text-secondary mt-phi-2">
      Future layers are labeled and never implied as shipped.
    </p>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/10" innerClass="max-w-5xl">
    <SectionHeader
      eyebrow="Implementation Path"
      title="Build the ecosystem in phases"
      subtitle="Start with the kernel loop, then governance, then bundled modules. Each phase has a clear exit criteria."
      class="mb-phi-3"
      maxWidth="max-w-3xl"
    />
    <div class="grid md:grid-cols-3 gap-phi-2">
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 1</p>
        <h3 class="text-lg font-display text-text-primary">Kernel Foundation</h3>
        <p class="text-sm text-text-secondary">
          Establish the coordination DB and complete the 6-call loop end to end.
        </p>
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
        <ul class="text-sm text-text-secondary space-y-phi-1">
          <li>- Lease released with outcome</li>
          <li>- Evidence + decision logged</li>
          <li>- Status visible via <span class="text-text-primary">motus work status</span></li>
        </ul>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 2</p>
        <h3 class="text-lg font-display text-text-primary">Governance + Evidence</h3>
        <p class="text-sm text-text-secondary">
          Validate the audit trail and enforce evidence requirements before completion.
        </p>
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
        <ul class="text-sm text-text-secondary space-y-phi-1">
          <li>- Evidence bundles are stored</li>
          <li>- Decision log is populated</li>
          <li>- Policy gates are satisfied</li>
        </ul>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 3</p>
        <h3 class="text-lg font-display text-text-primary">Bundled Modules</h3>
        <p class="text-sm text-text-secondary">
          Add optional capabilities only after kernel + governance are stable.
        </p>
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
        <ul class="text-sm text-text-secondary space-y-phi-1">
          <li>- Module dependencies satisfied</li>
          <li>- Registry status matches release</li>
          <li>- Module docs + tests exist</li>
        </ul>
      </Panel>
    </div>
    <div class="mt-phi-3 flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
      <span>Need the step-by-step commands?</span>
      <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">
        Open the Implementation Guide &#8594;
      </a>
    </div>
    <Panel size="sm" class="mt-phi-3 space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Ecosystem Outcomes</p>
      <div class="flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
        <span class="text-text-primary">Signed work receipts</span>
        <span class="text-text-secondary/60">&#8594;</span>
        <span class="text-text-primary">Asset registry</span>
        <span class="text-text-secondary/60">&#8594;</span>
        <span class="text-text-primary">Motus Exchange</span>
      </div>
      <p class="text-text-secondary text-sm">
        These future layers are explicit in the registry and always labeled as future until shipped.
      </p>
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">
          See future module definitions &#8594;
        </a>
        <a
          href={`${base}open-source`}
          class="text-mint hover:text-text-primary transition-colors"
        >
          Source available &#8594;
        </a>
      </div>
    </Panel>
  </Section>
</Layout>
