---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import SectionHeader from '../components/SectionHeader.astro';
import Panel from '../components/Panel.astro';
import EcosystemFlow from '../components/EcosystemFlow.astro';

import ecosystemMap from '../data/ecosystem-map.json';
import proofLedger from '../data/proof-ledger.json';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const groups = ecosystemMap.groups || [];
const nodes = ecosystemMap.nodes || [];
const proofIndex = new Map((proofLedger.claims || []).map((claim) => [claim.id, claim]));
const missingProof = nodes
  .filter((node) => node.proof_id && !proofIndex.has(node.proof_id))
  .map((node) => node.proof_id);

if (missingProof.length > 0) {
  throw new Error(`Ecosystem map references missing proof entries: ${missingProof.join(', ')}`);
}
---

<Layout title="Ecosystem Map - Motus">
  <Section tone="dark" class="text-center" innerClass="max-w-3xl">
    <SectionHeader
      eyebrow="Ecosystem Blueprint"
      title="The finished system, mapped in one view"
      subtitle="Motus Core is the center. Inputs, modules, governance, and future layers surround it. Colors show current, building, and future."
      as="h1"
      size="xl"
    />
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/10">
    <SectionHeader
      eyebrow="System Map"
      title="Built as a complete ecosystem"
      subtitle="External inputs feed the core, modules extend capability, governance wraps execution, and the future economy builds on verified proof."
      class="mb-phi-4"
      maxWidth="max-w-3xl"
    />
    <Panel size="sm" class="mb-phi-4 space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.3em] text-text-secondary">How to read the map</p>
      <ul class="space-y-phi-1 text-sm text-text-secondary">
        <li>- Motus Core sits at the center of the ecosystem.</li>
        <li>- Inputs are external systems Motus upgrades (logos).</li>
        <li>- Modules extend the core without breaking invariants.</li>
        <li>- Governance wraps execution and records proof.</li>
        <li>- Future economy builds on signed, verifiable work.</li>
      </ul>
      <p class="text-sm text-text-secondary">
        The “Motus adds” line shows the 1+1=3 effect for each integration.
      </p>
    </Panel>
    <div class="flex flex-wrap items-center gap-phi-2 text-xs mb-phi-4">
      <span class="status-chip status-current">Current</span>
      <span class="status-chip status-building">Building</span>
      <span class="status-chip status-future">Future</span>
      <span class="status-chip status-external">External</span>
    </div>
    <p class="text-xs text-text-secondary mb-phi-4 max-w-3xl">
      Current items are shipped and verifiable. Building items are in flight with active roadmap IDs. Future items are directional and explicitly labeled.
    </p>
    <div class="max-w-6xl mx-auto">
      <EcosystemFlow groups={groups} nodes={nodes} base={base} proofIndex={proofIndex} />
    </div>
    <p class="text-sm text-text-secondary mt-phi-3">
      Future layers are labeled and never implied as shipped.
    </p>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/10" innerClass="max-w-5xl">
    <div class="grid md:grid-cols-2 gap-phi-3">
      <Panel size="sm" class="space-y-phi-2">
        <h3 class="text-xl font-display text-text-primary">Build from the inside out</h3>
        <p class="text-text-secondary text-sm">
          Start with the kernel and the 6-call loop. Then layer modules only after the core is stable.
        </p>
        <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors text-sm">
          Go to Implementation Guide &#8594;
        </a>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <h3 class="text-xl font-display text-text-primary">Keep claims verifiable</h3>
        <p class="text-text-secondary text-sm">
          Every node points to docs, proof, or a roadmap ID. That is the contract for the public website.
        </p>
        <a
          href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/website/ecosystem-map.yaml"
          class="text-mint hover:text-text-primary transition-colors text-sm"
          target="_blank"
          rel="noopener"
        >
          View ecosystem source &#8594;
        </a>
      </Panel>
    </div>
    <Panel size="sm" class="mt-phi-3 space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Ecosystem Outcomes</p>
      <div class="flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
        <span class="text-text-primary">Signed work receipts</span>
        <span class="text-text-secondary/60">&#8594;</span>
        <span class="text-text-primary">Asset registry</span>
        <span class="text-text-secondary/60">&#8594;</span>
        <span class="text-text-primary">Motus Exchange</span>
      </div>
      <p class="text-text-secondary text-sm">
        These future layers are explicit in the registry and always labeled as future until shipped.
      </p>
      <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors text-sm">
        See future module definitions &#8594;
      </a>
    </Panel>
  </Section>
</Layout>
