---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Panel from '../components/Panel.astro';
import SectionHeader from '../components/SectionHeader.astro';

import registry from '../data/module-registry.json';
import patternsData from '../data/implementation-patterns.json';

const kernel = registry.kernel;
const modules = registry.bundled_modules;
const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const statusClasses = {
  current: 'status-chip status-current',
  building: 'status-chip status-building',
  future: 'status-chip status-future',
};

const statusLabel = (status) => status.charAt(0).toUpperCase() + status.slice(1);
const moduleCounts = modules.reduce(
  (acc, module) => {
    acc[module.status] = (acc[module.status] || 0) + 1;
    return acc;
  },
  { current: 0, building: 0, future: 0 },
);
const patterns = patternsData.patterns;
const patternStatusClass = (status) => {
  if (status === 'verified') return 'status-badge status-current';
  return 'status-badge status-building';
};
const patternStatusLabel = (status) => {
  if (status === 'verified') return 'Verified';
  if (status === 'building') return 'Building';
  return 'Target';
};
const trainingSteps = [
  {
    id: 'install',
    title: 'Install Motus',
    goal: 'Install the CLI and verify it runs in your environment.',
    commands: ['pip install motusos', 'motus --help'],
    expected: 'CLI help prints and lists system + work commands.',
    proof: {
      label: 'PyPI Package',
      url: 'https://pypi.org/project/motusos/',
    },
    failure: 'motus: command not found',
    fix: 'Activate the Python environment where you installed motusos.',
  },
  {
    id: 'prime',
    title: 'Prime agent defaults',
    goal: 'Install onboarding defaults before any agent runs.',
    commands: ['motus install'],
    expected: 'Defaults install without errors.',
    proof: {
      label: 'Quickstart',
      url: `${base}quickstart`,
    },
    failure: 'Write permission errors',
    fix: 'Run in a writable directory or choose a different path.',
  },
  {
    id: 'init',
    title: 'Initialize a workspace',
    goal: 'Create the .motus layout for local state.',
    commands: ['motus init --lite --path .'],
    expected: '.motus/ is created in the target repo.',
    proof: {
      label: 'Kernel Guide',
      url: `${base}implementation#kernel`,
    },
    failure: '.motus exists but is incomplete',
    fix: 'Re-run motus init --force to repair missing directories.',
  },
  {
    id: 'doctor',
    title: 'Run health checks',
    goal: 'Validate schema and migrations before execution.',
    commands: ['motus doctor'],
    expected: 'Health checks return OK status.',
    proof: {
      label: 'Quickstart',
      url: `${base}quickstart`,
    },
    failure: 'Schema/migration errors',
    fix: 'Run motus init --force and retry.',
  },
  {
    id: 'roadmap',
    title: 'Find a roadmap item',
    goal: 'Identify a ready item you can claim.',
    commands: ['motus roadmap ready'],
    expected: 'A list of ready items with IDs.',
    proof: {
      label: 'Kernel Schema',
      url: `${base}schema`,
    },
    failure: 'No ready items listed',
    fix: 'Seed a roadmap item in coordination.db or load a project roadmap.',
  },
  {
    id: 'claim',
    title: 'Claim work',
    goal: 'Start a lease for the task you are about to execute.',
    commands: ['motus work claim <roadmap_id> --intent "Describe the task"'],
    expected: 'A lease_id is returned.',
    proof: {
      label: 'Coordination API',
      url: `${base}how-it-works`,
    },
    failure: 'Item not found or blocked',
    fix: 'Use a valid roadmap ID or wait for dependencies.',
  },
  {
    id: 'context-outcome',
    title: 'Context + outcome',
    goal: 'Fetch fresh context and register the deliverable.',
    commands: [
      'motus work context <lease_id>',
      'motus work outcome <lease_id> file --path src/example.py --description "Deliverable"',
    ],
    expected: 'Context and outcome are recorded against the lease.',
    proof: {
      label: 'Coordination API',
      url: `${base}how-it-works`,
    },
    failure: 'Lease expired or missing',
    fix: 'Re-claim the work and retry.',
  },
  {
    id: 'verify-release',
    title: 'Evidence, decision, release',
    goal: 'Attach proof, log the decision, and release the lease.',
    commands: [
      'motus work evidence <lease_id> test_result --passed 12 --failed 0',
      'motus work decision <lease_id> "Decision summary" --rationale "Why this path"',
      'motus work release <lease_id> success',
    ],
    expected: 'Lease released with evidence and decision logged.',
    proof: {
      label: 'Coordination API',
      url: `${base}how-it-works`,
    },
    failure: 'Missing evidence or decision',
    fix: 'Add at least one evidence entry and decision before release.',
  },
  {
    id: 'audit',
    title: 'Audit the record',
    goal: 'Confirm the final state is visible and reviewable.',
    commands: ['motus work status <lease_id>'],
    expected: 'Status shows outcome, evidence, and decision entries.',
    proof: {
      label: 'Kernel Guide',
      url: `${base}implementation#kernel`,
    },
    failure: 'Missing evidence or decision in status output',
    fix: 'Re-run motus work evidence / decision and recheck.',
  },
];
---

<Layout title="Implementation">
  <Section tone="light" innerClass="max-w-6xl">
    <section class="space-y-phi-3">
      <SectionHeader
        eyebrow="Implementation Guide"
        title="Implement Motus in 9 steps"
        subtitle="Start with the training path below. Reference sections follow if you need kernel or module details."
        as="h1"
        align="left"
        size="xl"
        maxWidth="max-w-3xl"
      />
    </section>

    <section id="start-here" class="mt-phi-5 space-y-phi-3 scroll-mt-24">
      <SectionHeader
        eyebrow="Start Here"
        title="Implementation as a training path"
        subtitle="Follow four stages: setup, first success, proof, then scale. Each stage has a clear outcome before you move on."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-phi-2">
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Stage 1</p>
          <h3 class="text-lg font-display text-text-primary">Setup + Prime</h3>
          <p class="text-sm text-text-secondary">Install Motus and prime defaults for local execution.</p>
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Outcome</p>
          <p class="text-sm text-text-secondary">CLI runs and .motus/ is created.</p>
        </Panel>
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Stage 2</p>
          <h3 class="text-lg font-display text-text-primary">First Success</h3>
          <p class="text-sm text-text-secondary">Claim a lease, fetch context, and register an outcome.</p>
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Outcome</p>
          <p class="text-sm text-text-secondary">Lease ID returned with outcome attached.</p>
        </Panel>
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Stage 3</p>
          <h3 class="text-lg font-display text-text-primary">Proof + Release</h3>
          <p class="text-sm text-text-secondary">Attach evidence, log a decision, and release the lease.</p>
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Outcome</p>
          <p class="text-sm text-text-secondary">Receipt shows evidence + rationale.</p>
        </Panel>
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Stage 4</p>
          <h3 class="text-lg font-display text-text-primary">Scale Safely</h3>
          <p class="text-sm text-text-secondary">Add governance gates and bundled modules with discipline.</p>
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Outcome</p>
          <p class="text-sm text-text-secondary">Registry status matches release.</p>
        </Panel>
      </div>
      <div class="flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
        <span>Ready for the exact commands?</span>
        <a href="#step-by-step" class="text-mint hover:text-text-primary transition-colors">
          Jump to step-by-step &#8594;
        </a>
      </div>
    </section>

    <section id="step-by-step" class="mt-phi-5 space-y-phi-3">
      <SectionHeader
        eyebrow="Implementation Path"
        title="Step-by-step commands"
        subtitle="Follow each step in order. Every step includes the exact command, expected result, and proof link."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="relative">
        <span class="absolute left-phi-2 top-0 bottom-0 w-px bg-line/20"></span>
        <ol class="space-y-phi-3 pl-phi-5">
          {trainingSteps.map((step, index) => (
            <li id={step.id} class="relative scroll-mt-24">
              <span class="absolute left-phi-2 top-phi-2 -translate-x-1/2 flex h-8 w-8 items-center justify-center rounded-full border border-line/30 bg-surface text-xs font-mono text-text-secondary">
                {String(index + 1).padStart(2, '0')}
              </span>
              <Panel size="sm" class="space-y-phi-2">
                <div class="flex flex-wrap items-center justify-between gap-phi-2">
                  <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">
                    Step {String(index + 1).padStart(2, '0')}
                  </p>
                  {step.proof ? (
                    <a
                      href={step.proof.url}
                      class="text-xs uppercase tracking-[0.2em] text-mint hover:text-text-primary transition-colors"
                      target="_blank"
                      rel="noopener"
                    >
                      Proof: {step.proof.label} &#8594;
                    </a>
                  ) : null}
                </div>
                <h3 class="text-xl font-display text-text-primary">{step.title}</h3>
                <p class="text-sm text-text-secondary">{step.goal}</p>
                <div class="grid md:grid-cols-2 gap-phi-2">
                  <div class="space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Commands</p>
                    {step.commands.map((command) => (
                      <code class="text-mint font-mono text-sm block">{command}</code>
                    ))}
                  </div>
                  <div class="space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Expected</p>
                    <p class="text-sm text-text-secondary">{step.expected}</p>
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary mt-phi-2">If it fails</p>
                    <p class="text-sm text-text-secondary">{step.failure}</p>
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary mt-phi-2">Fix</p>
                    <p class="text-sm text-text-secondary">{step.fix}</p>
                  </div>
                </div>
              </Panel>
            </li>
          ))}
        </ol>
      </div>
      <p class="text-sm text-text-secondary">
        Use <span class="text-text-primary font-medium">motus</span> as the CLI entrypoint (mc remains as a
        deprecated alias). Continue with the 6-call execution loop in
        <a href={`${base}how-it-works`} class="text-mint hover:text-text-primary transition-colors"> How It Works</a>.
      </p>
      <p class="text-sm text-text-secondary">
        Reference details:
        <a href="#kernel" class="text-mint hover:text-text-primary transition-colors"> Kernel foundation</a>
        <span class="text-text-secondary/60"> · </span>
        <a href="#module-registry" class="text-mint hover:text-text-primary transition-colors"> Module registry</a>
      </p>
    </section>

    <section id="implementation-patterns" class="mt-phi-6 space-y-phi-3 scroll-mt-24">
      <SectionHeader
        eyebrow="Proven Patterns"
        title="Implementation strategies that prevent drift"
        subtitle="These patterns keep execution deterministic and auditable. Each includes what it is, why it matters, and how to apply it."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="grid md:grid-cols-2 gap-phi-2">
        {patterns.map((pattern) => {
          const proofHref = pattern.proof
            ? pattern.proof.url.startsWith('http')
              ? pattern.proof.url
              : `${base}${pattern.proof.url.replace(/^\/+/, '')}`
            : null;
          return (
            <div id={pattern.id} class="scroll-mt-24">
              <Panel size="sm" class="space-y-phi-2">
                <div class="flex items-center justify-between gap-phi-2">
                  <h3 class="text-lg font-display text-text-primary">{pattern.title}</h3>
                  <span class={patternStatusClass(pattern.status)}>{patternStatusLabel(pattern.status)}</span>
                </div>
                <p class="text-sm text-text-secondary">{pattern.summary}</p>
                <div class="grid md:grid-cols-3 gap-phi-2 text-sm text-text-secondary">
                  <div class="space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">What</p>
                    <p>{pattern.what}</p>
                  </div>
                  <div class="space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Why</p>
                    <p>{pattern.why}</p>
                  </div>
                  <div class="space-y-phi-1">
                    <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">How</p>
                    <ul class="space-y-phi-1">
                      {pattern.how.map((step) => (
                        <li>- {step}</li>
                      ))}
                    </ul>
                  </div>
                </div>
                {proofHref ? (
                  <a
                    href={proofHref}
                    class="text-xs uppercase tracking-[0.2em] text-mint hover:text-text-primary transition-colors"
                  >
                    Proof: {pattern.proof.label} &#8594;
                  </a>
                ) : (
                  <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">
                    Status: {patternStatusLabel(pattern.status)}
                  </p>
                )}
              </Panel>
            </div>
          );
        })}
      </div>
      <Panel size="sm" class="mt-phi-3 space-y-phi-1">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Quick Reference</p>
        <ul class="space-y-phi-1 text-sm text-text-secondary">
          {patterns.map((pattern) => (
            <li>
              <a href={`#${pattern.id}`} class="text-mint hover:text-text-primary transition-colors">
                {pattern.title}
              </a>
              <span class="text-text-secondary/60"> — </span>
              <span>{pattern.quick}</span>
            </li>
          ))}
        </ul>
      </Panel>
    </section>

    <section id="phase-gates" class="mt-phi-6 space-y-phi-3 scroll-mt-24">
      <SectionHeader
        eyebrow="Phase Gates"
        title="Implementation, in order"
        subtitle="Each phase has a clear exit criteria. Only move forward when the gate is satisfied."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="grid md:grid-cols-3 gap-phi-2">
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 1</p>
          <h3 class="text-lg font-display text-text-primary">Kernel Foundation</h3>
          <p class="text-sm text-text-secondary">
            Establish the coordination DB and complete the 6-call loop end to end.
          </p>
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
          <ul class="text-sm text-text-secondary space-y-phi-1">
            <li>- Lease released with outcome</li>
            <li>- Evidence + decision logged</li>
            <li>- Status visible via <span class="text-text-primary">motus work status</span></li>
          </ul>
        </Panel>
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 2</p>
          <h3 class="text-lg font-display text-text-primary">Governance + Evidence</h3>
          <p class="text-sm text-text-secondary">
            Validate the audit trail and enforce evidence requirements before completion.
          </p>
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
          <ul class="text-sm text-text-secondary space-y-phi-1">
            <li>- Evidence bundles are stored</li>
            <li>- Decision log is populated</li>
            <li>- Policy gates are satisfied</li>
          </ul>
        </Panel>
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Phase 3</p>
          <h3 class="text-lg font-display text-text-primary">Bundled Modules</h3>
          <p class="text-sm text-text-secondary">
            Add optional capabilities only after kernel + governance are stable.
          </p>
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Exit criteria</p>
          <ul class="text-sm text-text-secondary space-y-phi-1">
            <li>- Module dependencies satisfied</li>
            <li>- Registry status matches release</li>
            <li>- Module docs + tests exist</li>
          </ul>
        </Panel>
      </div>
    </section>

    <section class="mt-phi-6 space-y-phi-3">
      <div id="kernel" class="scroll-mt-24"></div>
      <SectionHeader
        eyebrow="Reference"
        title="Kernel foundation (Phase 1)"
        subtitle="Use after the step-by-step path if you need deeper kernel detail."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="flex flex-wrap items-center gap-phi-2">
        <h2 class="text-3xl font-display text-text-primary">Phase 1: {kernel.marketing_name}</h2>
        <span class={statusClasses[kernel.status]}>{statusLabel(kernel.status)}</span>
      </div>

      <p class="text-text-secondary max-w-3xl">{kernel.description}</p>

      <div class="grid md:grid-cols-2 gap-phi-3">
        <Panel size="sm">
          <h3 class="text-lg font-display text-text-primary">Primary Surfaces</h3>
          <ul class="mt-phi-2 space-y-phi-1 text-sm text-text-secondary">
            {kernel.primary_surfaces.map((item) => (
              <li>- {item}</li>
            ))}
          </ul>
        </Panel>
        <Panel size="sm">
          <h3 class="text-lg font-display text-text-primary">Best Practices</h3>
          <ul class="mt-phi-2 space-y-phi-1 text-sm text-text-secondary">
            {kernel.best_practices.map((item) => (
              <li>- {item}</li>
            ))}
          </ul>
        </Panel>
      </div>
      <div class="grid md:grid-cols-2 gap-phi-3">
        <Panel size="sm" class="space-y-phi-1">
          <h3 class="text-lg font-display text-text-primary">Verify the loop</h3>
          <p class="text-sm text-text-secondary">
            The kernel is ready when a lease completes with evidence and a decision.
          </p>
          <code class="text-mint font-mono text-sm">motus work status &lt;lease_id&gt;</code>
        </Panel>
        <Panel size="sm" class="space-y-phi-1">
          <h3 class="text-lg font-display text-text-primary">Evidence location</h3>
          <p class="text-sm text-text-secondary">
            Evidence and decisions are stored in the kernel ledger for audit review.
          </p>
          <code class="text-mint font-mono text-sm">~/.motus/coordination.db</code>
        </Panel>
      </div>
    </section>

    <section class="mt-phi-6 space-y-phi-3">
      <div id="module-registry" class="scroll-mt-24"></div>
      <SectionHeader
        eyebrow="Reference"
        title="Module registry (Phase 3)"
        subtitle="Bundled modules are optional capabilities that extend the kernel without breaking invariants."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <span class={statusClasses.current}>Current {moduleCounts.current}</span>
        <span class={statusClasses.building}>Building {moduleCounts.building}</span>
        <span class={statusClasses.future}>Future {moduleCounts.future}</span>
        <span class="text-text-secondary text-xs">
          Source:
          <a
            class="text-mint hover:text-text-primary transition-colors"
            href={`${base}implementation#module-registry`}
          >
            module registry
          </a>
        </span>
      </div>
      <Panel size="sm" class="space-y-phi-1">
        <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Readiness checklist</p>
        <ul class="text-sm text-text-secondary space-y-phi-1">
          <li>- Kernel loop passes with evidence + decision</li>
          <li>- Governance gates are enforced in policy</li>
          <li>- Module docs and tests are ready</li>
        </ul>
      </Panel>

      <div class="grid md:grid-cols-2 gap-phi-3">
        {modules.map((module) => (
          <div id={module.id} class="scroll-mt-24">
            <Panel size="sm" class="space-y-phi-2">
              <div class="flex items-start justify-between gap-phi-2">
                <div>
                  <h3 class="text-lg font-display text-text-primary">{module.marketing_name}</h3>
                  <p class="text-sm text-text-secondary">{module.description}</p>
                </div>
                <span class={statusClasses[module.status]}>{statusLabel(module.status)}</span>
              </div>
              <ul class="space-y-phi-1 text-sm text-text-secondary">
                {module.best_practices.slice(0, 2).map((item) => (
                  <li>- {item}</li>
                ))}
              </ul>
              <div class="flex flex-wrap gap-phi-1 text-xs text-text-secondary">
                <span class="px-2 py-1 rounded-full border border-line/10">{module.scope}</span>
                {module.roadmap_id ? (
                  <span class="px-2 py-1 rounded-full border border-line/10">{module.roadmap_id}</span>
                ) : null}
                {module.implementation_guides?.docs ? (
                  <a
                    href={`${base}implementation#${module.id}`}
                    class="text-mint hover:text-text-primary transition-colors"
                  >
                    Details
                  </a>
                ) : null}
              </div>
            </Panel>
          </div>
        ))}
      </div>
    </section>

    <section class="mt-phi-6 space-y-phi-2">
      <SectionHeader
        title="Docs Reference"
        subtitle="The canonical docs and registry live in the public repo. These links are the source of truth for implementation details."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="flex flex-wrap gap-3 text-sm">
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}quickstart`}>
          Quickstart
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}how-it-works`}>
          Coordination API
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}schema`}>
          Kernel Schema
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}implementation#kernel`}>
          Kernel Guide
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}implementation#module-registry`}>
          Module Registry
        </a>
      </div>
    </section>
  </Section>
</Layout>
