---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Panel from '../components/Panel.astro';
import SectionHeader from '../components/SectionHeader.astro';

import patternsData from '../data/implementation-patterns.json';
import moduleRegistry from '../data/module-registry.json';
import { validatePatterns } from '../data/validate-patterns.js';
import { getStatusClass, getStatusLabel } from '../lib/status.js';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const patterns = patternsData.patterns;
validatePatterns(patterns);
const patternStatusClass = (status) => getStatusClass(status, 'badge');
const patternStatusLabel = (status) => getStatusLabel(status);

const patternOrder = [
  'evidence-gates',
  'stop-conditions',
  'clean-verification',
  'claim-labeling',
  'agent-charters',
  'health-baselines',
  'public-proof',
];

const patternsById = new Map(patterns.map((pattern) => [pattern.id, pattern]));
const orderedPatterns = patternOrder
  .map((id) => patternsById.get(id))
  .filter(Boolean);
const remainingPatterns = patterns.filter((pattern) => !patternOrder.includes(pattern.id));
const displayPatterns = [...orderedPatterns, ...remainingPatterns];
const modules = [moduleRegistry.kernel, ...moduleRegistry.bundled_modules];
---

<Layout title="Implementation">
  <Section tone="light" innerClass="max-w-6xl">
    <section class="space-y-phi-2 md:space-y-phi-3">
      <SectionHeader
        eyebrow="Implementation Guide"
        title="Implement without drift"
        subtitle="Run the loop once, then apply the patterns below to keep execution verifiable."
        as="h1"
        align="left"
        size="xl"
        maxWidth="max-w-3xl"
      />
      <div class="flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
        <span>New here?</span>
        <a href={`${base}get-started`} class="text-mint hover:text-text-primary transition-colors">
          Go to Get Started &#8594;
        </a>
      </div>
    </section>

    <section class="mt-phi-5 md:mt-phi-6 space-y-phi-2 md:space-y-phi-3">
      <SectionHeader
        eyebrow="Start"
        title="Run the loop once"
        subtitle="Get Started produces your first receipt. Then apply the patterns below to scale safely."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <Panel size="sm" class="flex flex-wrap items-center justify-between gap-phi-2">
        <p class="text-sm text-text-secondary">
          New to Motus? Run the hands-on loop first.
        </p>
        <a href={`${base}get-started`} class="text-mint hover:text-text-primary transition-colors text-sm">
          Get Started &#8594;
        </a>
      </Panel>
    </section>

    <section id="implementation-patterns" class="mt-phi-5 md:mt-phi-6 space-y-phi-2 md:space-y-phi-3 scroll-mt-24">
      <SectionHeader
        eyebrow="Execution Patterns"
        title="Implement without drift"
        subtitle="Each pattern is labeled Current, Building, or Future. Apply what’s current first."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="space-y-phi-2">
        {displayPatterns.map((pattern) => {
          const proofHref = pattern.proof
            ? pattern.proof.url.startsWith('http')
              ? pattern.proof.url
              : `${base}${pattern.proof.url.replace(/^\/+/, '')}`
            : null;
          return (
            <Panel id={pattern.id} size="sm" class="space-y-phi-2 scroll-mt-24">
              <div class="flex items-start justify-between gap-phi-2">
                <div class="space-y-phi-1">
                  <h3 class="text-lg font-display text-text-primary">{pattern.title}</h3>
                  <p class="text-sm text-text-secondary">{pattern.summary}</p>
                </div>
                <span class={patternStatusClass(pattern.status)}>{patternStatusLabel(pattern.status)}</span>
              </div>
              {pattern.id === 'evidence-gates' && <span id="phase-gates" class="sr-only">Phase gates</span>}
              <div class="grid md:grid-cols-2 gap-phi-2">
                <div class="space-y-phi-1">
                  <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">Why it matters</p>
                  <p class="text-sm text-text-secondary">{pattern.why}</p>
                </div>
                <div class="space-y-phi-1">
                  <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">How to apply</p>
                  <ul class="text-sm text-text-secondary space-y-phi-1">
                    {pattern.how.map((step) => (
                      <li>- {step}</li>
                    ))}
                  </ul>
                </div>
              </div>
              {proofHref ? (
                <a
                  href={proofHref}
                  class="text-sm uppercase tracking-[0.2em] text-mint hover:text-text-primary transition-colors"
                >
                  Proof: {pattern.proof.label} &#8594;
                </a>
              ) : (
                <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">
                  Status: {patternStatusLabel(pattern.status)}
                </p>
              )}
            </Panel>
          );
        })}
      </div>
      <Panel size="sm" class="mt-phi-2 md:mt-phi-3 space-y-phi-1">
        <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">Quick Reference</p>
        <ul class="space-y-phi-1 text-sm text-text-secondary">
          {displayPatterns.map((pattern) => (
            <li>
              <a href={`#${pattern.id}`} class="text-mint hover:text-text-primary transition-colors">
                {pattern.title}
              </a>
              <span class="text-text-secondary/60"> — </span>
              <span>{pattern.quick}</span>
            </li>
          ))}
        </ul>
      </Panel>
    </section>

    <section id="module-registry" class="mt-phi-5 md:mt-phi-6 space-y-phi-2 scroll-mt-24">
      <SectionHeader
        eyebrow="Modules"
        title="Module reference anchors"
        subtitle="The ecosystem map and registry link here for quick context. Use docs for full module details."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="grid md:grid-cols-2 gap-phi-2">
        {modules.map((module) => (
          <Panel id={module.id} size="sm" class="space-y-phi-1 scroll-mt-24">
            <div class="flex items-start justify-between gap-phi-2">
              <div>
                <h3 class="text-lg font-display text-text-primary">{module.marketing_name}</h3>
                <p class="text-sm text-text-secondary">{module.description}</p>
              </div>
              <span class={patternStatusClass(module.status)}>{patternStatusLabel(module.status)}</span>
            </div>
          </Panel>
        ))}
      </div>
    </section>

    <section class="mt-phi-5 md:mt-phi-6 space-y-phi-2">
      <SectionHeader
        title="Reference links"
        subtitle="Use these after you’ve run Get Started."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}how-it-works`}>
          How it works
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}docs/gates`}>
          Evidence gates
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}docs/evidence`}>
          Evidence registry
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}docs/schema`}>
          Kernel schema
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href={`${base}docs/ecosystem`}>
          Ecosystem map
        </a>
      </div>
    </section>
  </Section>
</Layout>
