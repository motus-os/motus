---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Panel from '../components/Panel.astro';
import SectionHeader from '../components/SectionHeader.astro';

import registry from '../data/module-registry.json';

const kernel = registry.kernel;
const modules = registry.bundled_modules;
const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const statusClasses = {
  current: 'status-chip status-current',
  building: 'status-chip status-building',
  future: 'status-chip status-future',
};

const statusLabel = (status) => status.charAt(0).toUpperCase() + status.slice(1);
const moduleCounts = modules.reduce(
  (acc, module) => {
    acc[module.status] = (acc[module.status] || 0) + 1;
    return acc;
  },
  { current: 0, building: 0, future: 0 },
);
const trainingSteps = [
  {
    id: 'install',
    title: 'Install Motus',
    goal: 'Install the CLI and verify it runs in your environment.',
    commands: ['pip install motusos', 'motus --help'],
    expected: 'CLI help prints and lists system + work commands.',
    proof: {
      label: 'CLI Reference',
      url: 'https://github.com/motus-os/motus/blob/main/packages/cli/docs/cli-reference.md',
    },
    failure: 'motus: command not found',
    fix: 'Activate the Python environment where you installed motusos.',
  },
  {
    id: 'prime',
    title: 'Prime agent defaults',
    goal: 'Install onboarding defaults before any agent runs.',
    commands: ['motus install'],
    expected: 'Defaults install without errors.',
    proof: {
      label: 'CLI Reference',
      url: 'https://github.com/motus-os/motus/blob/main/packages/cli/docs/cli-reference.md',
    },
    failure: 'Write permission errors',
    fix: 'Run in a writable directory or choose a different path.',
  },
  {
    id: 'init',
    title: 'Initialize a workspace',
    goal: 'Create the .motus layout for local state.',
    commands: ['motus init --lite --path .'],
    expected: '.motus/ is created in the target repo.',
    proof: {
      label: 'Kernel Guide',
      url: 'https://github.com/motus-os/motus/blob/main/packages/cli/docs/implementation/kernel.md',
    },
    failure: '.motus exists but is incomplete',
    fix: 'Re-run motus init --force to repair missing directories.',
  },
  {
    id: 'doctor',
    title: 'Run health checks',
    goal: 'Validate schema and migrations before execution.',
    commands: ['motus doctor'],
    expected: 'Health checks return OK status.',
    proof: {
      label: 'CLI Reference',
      url: 'https://github.com/motus-os/motus/blob/main/packages/cli/docs/cli-reference.md',
    },
    failure: 'Schema/migration errors',
    fix: 'Run motus init --force and retry.',
  },
  {
    id: 'claim',
    title: 'Claim work',
    goal: 'Start a lease for the task you are about to execute.',
    commands: ['motus work claim RI-000 --intent "Describe the task"'],
    expected: 'A lease_id is returned.',
    proof: {
      label: 'Coordination API',
      url: 'https://github.com/motus-os/motus/blob/main/packages/cli/docs/api/coordination-api.md',
    },
    failure: 'Item not found or blocked',
    fix: 'Use a valid roadmap ID or wait for dependencies.',
  },
  {
    id: 'context-outcome',
    title: 'Context + outcome',
    goal: 'Fetch fresh context and register the deliverable.',
    commands: [
      'motus work context <lease_id>',
      'motus work outcome <lease_id> file --path src/example.py --description "Deliverable"',
    ],
    expected: 'Context and outcome are recorded against the lease.',
    proof: {
      label: 'Coordination API',
      url: 'https://github.com/motus-os/motus/blob/main/packages/cli/docs/api/coordination-api.md',
    },
    failure: 'Lease expired or missing',
    fix: 'Re-claim the work and retry.',
  },
  {
    id: 'verify-release',
    title: 'Evidence, decision, release',
    goal: 'Attach proof, log the decision, and release the lease.',
    commands: [
      'motus work evidence <lease_id> test_result --passed 12 --failed 0',
      'motus work decision <lease_id> "Decision summary" --rationale "Why this path"',
      'motus work release <lease_id> success',
    ],
    expected: 'Lease released with evidence and decision logged.',
    proof: {
      label: 'Coordination API',
      url: 'https://github.com/motus-os/motus/blob/main/packages/cli/docs/api/coordination-api.md',
    },
    failure: 'Missing evidence or decision',
    fix: 'Add at least one evidence entry and decision before release.',
  },
];
---

<Layout title="Implementation">
  <Section tone="light" innerClass="max-w-6xl">
    <section class="space-y-phi-3">
      <SectionHeader
        eyebrow="Implementation Guide"
        title="Kernel + Bundled Modules"
        subtitle="This page documents how to implement Motus correctly. The kernel is the non-negotiable execution layer. Bundled modules add capabilities while preserving kernel invariants."
        as="h1"
        align="left"
        size="xl"
        maxWidth="max-w-3xl"
      />
    </section>

    <section class="mt-phi-5 space-y-phi-3">
      <SectionHeader
        eyebrow="Implementation Path"
        title="Start from the basics"
        subtitle="Follow the steps in order. Each step includes the exact command, expected result, and the proof link behind it."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <ol class="space-y-phi-3">
        {trainingSteps.map((step, index) => (
          <li id={step.id} class="scroll-mt-24">
            <Panel size="sm" class="space-y-phi-2">
              <div class="flex flex-wrap items-center justify-between gap-phi-2">
                <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">
                  Step {String(index + 1).padStart(2, '0')}
                </p>
                {step.proof ? (
                  <a
                    href={step.proof.url}
                    class="text-xs uppercase tracking-[0.2em] text-mint hover:text-text-primary transition-colors"
                    target="_blank"
                    rel="noopener"
                  >
                    Proof: {step.proof.label} &#8594;
                  </a>
                ) : null}
              </div>
              <h3 class="text-xl font-display text-text-primary">{step.title}</h3>
              <p class="text-sm text-text-secondary">{step.goal}</p>
              <div class="grid md:grid-cols-2 gap-phi-2">
                <div class="space-y-phi-1">
                  <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Commands</p>
                  {step.commands.map((command) => (
                    <code class="text-mint font-mono text-sm block">{command}</code>
                  ))}
                </div>
                <div class="space-y-phi-1">
                  <p class="text-xs uppercase tracking-[0.2em] text-text-secondary">Expected</p>
                  <p class="text-sm text-text-secondary">{step.expected}</p>
                  <p class="text-xs uppercase tracking-[0.2em] text-text-secondary mt-phi-2">If it fails</p>
                  <p class="text-sm text-text-secondary">{step.failure}</p>
                  <p class="text-xs uppercase tracking-[0.2em] text-text-secondary mt-phi-2">Fix</p>
                  <p class="text-sm text-text-secondary">{step.fix}</p>
                </div>
              </div>
            </Panel>
          </li>
        ))}
      </ol>
      <p class="text-sm text-text-secondary">
        Use <span class="text-text-primary font-medium">motus</span> as the CLI entrypoint (mc remains as a
        deprecated alias). Continue with the 6-call execution loop in
        <a href={`${base}how-it-works`} class="text-mint hover:text-text-primary transition-colors"> How It Works</a>.
      </p>
    </section>

    <section class="mt-phi-6 space-y-phi-3">
      <div id="kernel" class="scroll-mt-24"></div>
      <div class="flex flex-wrap items-center gap-phi-2">
        <h2 class="text-3xl font-display text-text-primary">{kernel.marketing_name}</h2>
        <span class={statusClasses[kernel.status]}>{statusLabel(kernel.status)}</span>
      </div>

      <p class="text-text-secondary max-w-3xl">{kernel.description}</p>

      <div class="grid md:grid-cols-2 gap-phi-3">
        <Panel size="sm">
          <h3 class="text-lg font-display text-text-primary">Primary Surfaces</h3>
          <ul class="mt-phi-2 space-y-phi-1 text-sm text-text-secondary">
            {kernel.primary_surfaces.map((item) => (
              <li>- {item}</li>
            ))}
          </ul>
        </Panel>
        <Panel size="sm">
          <h3 class="text-lg font-display text-text-primary">Best Practices</h3>
          <ul class="mt-phi-2 space-y-phi-1 text-sm text-text-secondary">
            {kernel.best_practices.map((item) => (
              <li>- {item}</li>
            ))}
          </ul>
        </Panel>
      </div>
    </section>

    <section class="mt-phi-6 space-y-phi-3">
      <div id="module-registry" class="scroll-mt-24"></div>
      <SectionHeader
        title="Module Registry"
        subtitle="Bundled modules are optional capabilities that extend the kernel without breaking invariants. The registry tracks scope, status, and best practices for each module."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <span class={statusClasses.current}>Current {moduleCounts.current}</span>
        <span class={statusClasses.building}>Building {moduleCounts.building}</span>
        <span class={statusClasses.future}>Future {moduleCounts.future}</span>
        <span class="text-text-secondary text-xs">
          Source:
          <a
            class="text-mint hover:text-text-primary transition-colors"
            href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/standards/module-registry.yaml"
            target="_blank"
            rel="noopener"
          >
            module-registry.yaml
          </a>
        </span>
      </div>

      <div class="grid md:grid-cols-2 gap-phi-3">
        {modules.map((module) => (
          <div id={module.id} class="scroll-mt-24">
            <Panel size="sm" class="space-y-phi-2">
              <div class="flex items-start justify-between gap-phi-2">
                <div>
                  <h3 class="text-lg font-display text-text-primary">{module.marketing_name}</h3>
                  <p class="text-sm text-text-secondary">{module.description}</p>
                </div>
                <span class={statusClasses[module.status]}>{statusLabel(module.status)}</span>
              </div>
              <ul class="space-y-phi-1 text-sm text-text-secondary">
                {module.best_practices.slice(0, 2).map((item) => (
                  <li>- {item}</li>
                ))}
              </ul>
              <div class="flex flex-wrap gap-phi-1 text-xs text-text-secondary">
                <span class="px-2 py-1 rounded-full border border-line/10">{module.scope}</span>
                {module.roadmap_id ? (
                  <span class="px-2 py-1 rounded-full border border-line/10">{module.roadmap_id}</span>
                ) : null}
                {module.implementation_guides?.docs ? (
                  <a
                    href={`https://github.com/motus-os/motus/blob/main/${module.implementation_guides.docs}`}
                    class="text-mint hover:text-text-primary transition-colors"
                    target="_blank"
                    rel="noopener"
                  >
                    Docs
                  </a>
                ) : null}
              </div>
            </Panel>
          </div>
        ))}
      </div>
    </section>

    <section class="mt-phi-6 space-y-phi-2">
      <SectionHeader
        title="Docs Reference"
        subtitle="The canonical docs and registry live in the public repo. These links are the source of truth for implementation details."
        align="left"
        size="md"
        maxWidth="max-w-3xl"
      />
      <div class="flex flex-wrap gap-3 text-sm">
        <a class="text-mint hover:text-text-primary transition-colors" href="https://github.com/motus-os/motus/tree/main/packages/cli/docs" target="_blank" rel="noopener">
          Docs Index
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/cli-reference.md" target="_blank" rel="noopener">
          CLI Reference
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/api/coordination-api.md" target="_blank" rel="noopener">
          Coordination API
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/implementation/kernel.md" target="_blank" rel="noopener">
          Kernel Guide
        </a>
        <a class="text-mint hover:text-text-primary transition-colors" href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/standards/module-registry.yaml" target="_blank" rel="noopener">
          Module Registry
        </a>
      </div>
    </section>
  </Section>
</Layout>
