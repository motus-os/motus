---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Panel from '../components/Panel.astro';
import SectionHeader from '../components/SectionHeader.astro';
import MetricStat from '../components/MetricStat.astro';
import ModuleCard from '../components/ModuleCard.astro';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
const workSteps = [
  { label: "claim_work()", note: "Reserve the task" },
  { label: "get_context()", note: "Get relevant files" },
  { label: "put_outcome()", note: "Register deliverables" },
  { label: "record_evidence()", note: "Attach proof" },
  { label: "record_decision()", note: "Log rationale" },
  { label: "release_work()", note: "Complete + receipt" },
];
const moduleHighlights = [
  {
    name: 'LENS',
    focus: 'Reading',
    summary: {
      lead: 'Read only what matters.',
      rest: 'Deterministic file snapshots keep context tight and reproducible.',
    },
    bullets: [
      'Relevant files only',
      'Reproducible snapshots',
      'Token-efficient',
    ],
  },
  {
    name: 'LEASES',
    focus: 'Coordination',
    summary: {
      lead: 'No collision, no conflicts.',
      rest: 'Exclusive access to tasks until work is released.',
    },
    bullets: [
      'Exclusive task access',
      'Conflict detection',
      'Clean handoffs',
    ],
  },
  {
    name: 'RECEIPTS',
    focus: 'Trust',
    summary: {
      lead: 'Every action is reviewable.',
      rest: 'Outcome, evidence, and decision bundled together.',
    },
    bullets: [
      'Evidence bundles',
      'Decision logging',
      'Audit trail',
    ],
  },
  {
    name: 'STRATEGIES',
    focus: 'Reasoning',
    summary: {
      lead: 'Reuse decisions, not guesswork.',
      rest: 'Pattern library for consistent approaches.',
    },
    bullets: [
      'Decision patterns',
      'Trigger conditions',
      'Review heuristics',
    ],
  },
];
---

<Layout title="How It Works - Motus">
  <Section tone="dark" class="text-center" innerClass="max-w-3xl">
    <SectionHeader
      title="How It Works"
      subtitle="Every task ends with a reviewable receipt."
      as="h1"
      size="xl"
      class="mb-phi-4"
    />
    <div class="flex flex-wrap justify-center gap-phi-4 md:gap-phi-5">
      <div class="text-center">
        <MetricStat value="6" label="API calls" detail="Designed for low coordination overhead" />
        <a
          href={`${base}docs/evidence#claim-six_call_api`}
          class="text-sm uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors mt-phi-2 inline-flex"
        >
          Evidence &#8594;
        </a>
      </div>
      <div class="text-center">
        <MetricStat value="0" label="Cloud required" detail="Local-first, minimal setup" />
        <a
          href={`${base}docs/evidence#claim-no_cloud_dependency`}
          class="text-sm uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors mt-phi-2 inline-flex"
        >
          Evidence &#8594;
        </a>
      </div>
      <div class="text-center">
        <MetricStat value="1" label="Source of truth" detail="Deterministic work state" />
        <a
          href={`${base}docs/evidence#claim-coordination_db_source`}
          class="text-sm uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors mt-phi-2 inline-flex"
        >
          Evidence &#8594;
        </a>
      </div>
    </div>
    <p class="text-sm text-text-secondary mt-phi-3">
      Six-call loop, local-first state, one source of truth.
    </p>
    <p class="text-sm text-text-secondary mt-phi-3">
      Proof registry:
      <a href={`${base}docs/evidence`} class="text-mint hover:text-text-primary transition-colors">
        Evidence Registry &#8594;
      </a>
    </p>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/30" innerClass="max-w-5xl">
    <SectionHeader
      title="The Work Compiler"
      subtitle="Reviewable handoffs via a six-call loop with evidence and decisions."
      class="mb-phi-4"
      maxWidth="max-w-2xl"
    />

    <Panel size="lg" class="text-center">
      <div class="flex flex-wrap justify-center items-center gap-phi-2">
        {workSteps.map((step) => (
          <div class="flex flex-col items-center gap-phi-1 rounded-full border border-line/30 bg-surface/70 px-phi-2 py-phi-1">
            <span class="text-sm font-mono text-text-primary">{step.label}</span>
            <span class="text-sm text-text-secondary">{step.note}</span>
          </div>
        ))}
      </div>

      <p class="text-text-secondary text-sm text-center mt-phi-3 pt-phi-3 border-t border-line/30">
        A complete receipt includes outcome, evidence, and decision.
      </p>
    </Panel>
  </Section>

  <Section tone="light" class="border-t border-line/30">
    <SectionHeader
      subtitle="Reading, coordination, trust, and reasoning â€” each one with a receipt."
      class="mb-phi-5"
      size="xl"
      titleClassName="display-contrast"
    >
      <span slot="title">Four Modules. <strong>Four Ways to Keep Receipts.</strong></span>
    </SectionHeader>
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-phi-3">
      {moduleHighlights.map((module) => (
        <ModuleCard
          name={module.name}
          focus={module.focus}
          summaryLead={module.summary.lead}
          summaryRest={module.summary.rest}
          bullets={module.bullets}
          href={`${base}implementation`}
          cta="Explore module details"
        />
      ))}
    </div>
  </Section>

  <Section tone="muted" pad="tight" innerClass="max-w-5xl">
    <SectionHeader
      title="Coordination reference"
      subtitle="This page is the overview. The detailed API reference lives in GitHub."
      class="mb-phi-4"
      maxWidth="max-w-3xl"
    />
    <Panel size="sm" class="space-y-phi-2">
      <div class="flex flex-wrap gap-phi-2 text-sm text-text-secondary">
        <span class="px-2 py-1 rounded-full border border-line/30 bg-surface">claim_work</span>
        <span class="px-2 py-1 rounded-full border border-line/30 bg-surface">get_context</span>
        <span class="px-2 py-1 rounded-full border border-line/30 bg-surface">put_outcome</span>
        <span class="px-2 py-1 rounded-full border border-line/30 bg-surface">record_evidence</span>
        <span class="px-2 py-1 rounded-full border border-line/30 bg-surface">record_decision</span>
        <span class="px-2 py-1 rounded-full border border-line/30 bg-surface">release_work</span>
      </div>
      <p class="text-sm text-text-secondary">
        Full signatures, examples, and invariants live in the CLI reference and kernel docs.
      </p>
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <a
          href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/cli-reference.md"
          class="text-mint hover:text-text-primary transition-colors"
          target="_blank"
          rel="noopener"
        >
          CLI reference &#8594;
        </a>
        <a
          href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/implementation/kernel.md"
          class="text-mint hover:text-text-primary transition-colors"
          target="_blank"
          rel="noopener"
        >
          Kernel docs &#8594;
        </a>
      </div>
    </Panel>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <div id="gates" class="scroll-mt-24"></div>
    <div id="evidence-gates" class="scroll-mt-24"></div>
    <SectionHeader
      title="Gates keep the loop honest"
      subtitle="Policy, evidence, and completion gates define what a complete receipt looks like."
      class="mb-phi-4"
      maxWidth="max-w-3xl"
    />
    <Panel size="sm" class="space-y-phi-2">
      <p class="text-sm text-text-secondary">
        Gates describe what must be true before a receipt is accepted. Enforcement is building.
      </p>
      <div class="flex flex-wrap gap-phi-2 text-sm">
        <a href={`${base}docs/gates`} class="text-mint hover:text-text-primary transition-colors">
          Open the gates guide &#8594;
        </a>
        <a href={`${base}implementation#phase-gates`} class="text-mint hover:text-text-primary transition-colors">
          Phase gates &#8594;
        </a>
        <a href={`${base}docs/evidence`} class="text-mint hover:text-text-primary transition-colors">
          Evidence registry &#8594;
        </a>
      </div>
    </Panel>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <SectionHeader
      title="Go deeper"
      subtitle="Keep the site lightweight; use the canonical docs for full detail."
      class="mb-phi-4"
      maxWidth="max-w-3xl"
    />
    <div class="grid md:grid-cols-3 gap-phi-3">
      <Panel size="sm" class="space-y-phi-2">
        <h3 class="text-lg font-display text-text-primary">Kernel schema</h3>
        <p class="text-sm text-text-secondary">Authoritative tables and invariants.</p>
        <a href={`${base}docs/schema`} class="text-sm text-mint hover:text-text-primary transition-colors">
          Schema overview &#8594;
        </a>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <h3 class="text-lg font-display text-text-primary">Implementation guide</h3>
        <p class="text-sm text-text-secondary">Patterns and module references.</p>
        <a href={`${base}implementation`} class="text-sm text-mint hover:text-text-primary transition-colors">
          Implementation guide &#8594;
        </a>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <h3 class="text-lg font-display text-text-primary">API reference</h3>
        <p class="text-sm text-text-secondary">CLI commands and API signatures.</p>
        <a
          href="https://github.com/motus-os/motus/blob/main/packages/cli/docs/cli-reference.md"
          class="text-sm text-mint hover:text-text-primary transition-colors"
          target="_blank"
          rel="noopener"
        >
          CLI reference &#8594;
        </a>
      </Panel>
    </div>
  </Section>

  <Section tone="muted" class="text-center" innerClass="max-w-2xl">
    <SectionHeader title="Start the loop" size="md" class="mb-phi-3" />
    <p class="text-text-secondary">
      Run the six-call loop in your repo, then verify the receipt.
    </p>
    <div class="flex flex-wrap justify-center gap-phi-2 text-sm mt-phi-3">
      <a href={`${base}get-started`} class="text-mint hover:text-text-primary transition-colors">
        Get Started &#8594;
      </a>
      <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">
        Implementation guide &#8594;
      </a>
    </div>
  </Section>
</Layout>
