---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Panel from '../components/Panel.astro';
import SectionHeader from '../components/SectionHeader.astro';
import MetricStat from '../components/MetricStat.astro';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
const workSteps = [
  { label: "claim_work()", note: "Reserve work + lease" },
  { label: "get_context()", note: "Assemble the Lens" },
  { label: "put_outcome()", note: "Register deliverables" },
  { label: "record_evidence()", note: "Attach proof" },
  { label: "record_decision()", note: "Log rationale" },
  { label: "release_work()", note: "Finalize + release" },
];
---

<Layout title="How It Works - Motus">
  <Section tone="dark" class="text-center" innerClass="max-w-3xl">
    <SectionHeader
      title="How It Works"
      subtitle="Outcome: every task ends with a reviewable receipt."
      as="h1"
      size="xl"
      class="mb-phi-4"
    />
    <div class="flex flex-wrap justify-center gap-phi-4 md:gap-phi-5">
      <div class="text-center">
        <MetricStat value="6" label="API calls" detail="Designed for low coordination overhead" />
        <a
          href={`${base}evidence#claim-six_call_api`}
          class="text-xs uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors mt-phi-2 inline-flex"
        >
          Evidence &#8594;
        </a>
      </div>
      <div class="text-center">
        <MetricStat value="0" label="Cloud required" detail="Local-first, minimal setup" />
        <a
          href={`${base}evidence#claim-no_cloud_dependency`}
          class="text-xs uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors mt-phi-2 inline-flex"
        >
          Evidence &#8594;
        </a>
      </div>
      <div class="text-center">
        <MetricStat value="1" label="Source of truth" detail="Deterministic work state" />
        <a
          href={`${base}evidence#claim-coordination_db_source`}
          class="text-xs uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors mt-phi-2 inline-flex"
        >
          Evidence &#8594;
        </a>
      </div>
    </div>
    <p class="text-sm text-text-secondary mt-phi-3">
      Mechanism: six-call loop, local-first state, one source of truth.
    </p>
    <p class="text-sm text-text-secondary mt-phi-3">
      Proof registry:
      <a href={`${base}evidence`} class="text-mint hover:text-text-primary transition-colors">
        Evidence Registry &#8594;
      </a>
    </p>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/10" innerClass="max-w-5xl">
    <SectionHeader
      title="The Work Compiler"
      subtitle="Outcome: reviewable handoffs. Mechanism: six-call loop with evidence + decisions."
      class="mb-phi-4"
      maxWidth="max-w-2xl"
    />

    <Panel size="lg" class="text-center">
      <div class="flex flex-wrap justify-center items-center gap-phi-2">
        {workSteps.map((step) => (
          <div class="flex flex-col items-center gap-1 rounded-full border border-line/10 bg-surface/70 px-phi-2 py-phi-1">
            <span class="text-sm font-mono text-text-primary">{step.label}</span>
            <span class="text-xs text-text-secondary">{step.note}</span>
          </div>
        ))}
      </div>

      <p class="text-text-secondary text-sm text-center mt-phi-3 pt-phi-3 border-t border-line/10">
        Outcome: every lease closes with outcome, evidence, and decision.
      </p>
    </Panel>
  </Section>

  <Section tone="muted" pad="tight" innerClass="max-w-5xl">
    <SectionHeader
      title="The Coordination API"
      subtitle="Outcome: minimal surface, full audit trail."
      class="mb-phi-4"
      maxWidth="max-w-2xl"
    />

    <div class="grid md:grid-cols-2 gap-phi-3">
      <Panel size="sm">
        <code class="text-mint font-mono text-lg">claim_work()</code>
        <p class="text-text-secondary mt-2">Outcome: lease reserved with a Lens snapshot.</p>
      </Panel>

      <Panel size="sm">
        <code class="text-mint font-mono text-lg">get_context()</code>
        <p class="text-text-secondary mt-2">Outcome: refreshed Lens snapshot mid-task.</p>
      </Panel>

      <Panel size="sm">
        <code class="text-mint font-mono text-lg">put_outcome()</code>
        <p class="text-text-secondary mt-2">Outcome: deliverables registered to the lease.</p>
      </Panel>

      <Panel size="sm">
        <code class="text-mint font-mono text-lg">record_evidence()</code>
        <p class="text-text-secondary mt-2">Outcome: proof artifacts attached.</p>
      </Panel>

      <Panel size="sm">
        <code class="text-mint font-mono text-lg">record_decision()</code>
        <p class="text-text-secondary mt-2">Outcome: decision rationale logged.</p>
      </Panel>

      <Panel size="sm">
        <code class="text-mint font-mono text-lg">release_work()</code>
        <p class="text-text-secondary mt-2">Outcome: lease closed with a receipt.</p>
      </Panel>
    </div>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <SectionHeader
      title="Gates keep the loop honest"
      subtitle="Outcome: work cannot close without proof and decision."
      class="mb-phi-4"
      maxWidth="max-w-2xl"
    />
    <div id="gates" class="grid md:grid-cols-3 gap-phi-3 scroll-mt-24">
      <Panel size="sm" class="space-y-phi-2">
        <h3 class="text-lg font-display text-text-primary">Policy gate</h3>
        <div class="space-y-phi-1 text-sm text-text-secondary">
          <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Outcome</p>
          <p>Only eligible work can proceed.</p>
        </div>
        <div class="space-y-phi-1 text-sm text-text-secondary">
          <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Mechanism</p>
          <p>Validates eligibility, scope, and policy packs.</p>
        </div>
        <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Touches</p>
        <p class="text-sm text-text-secondary">claim_work → release_work</p>
        <a
          href={`${base}evidence#claim-policy_gates`}
          class="text-sm text-mint hover:text-text-primary transition-colors"
        >
          Evidence &#8594;
        </a>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <div id="evidence-gates" class="scroll-mt-24"></div>
        <h3 class="text-lg font-display text-text-primary">Evidence gate</h3>
        <div class="space-y-phi-1 text-sm text-text-secondary">
          <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Outcome</p>
          <p>Completion cannot happen without proof.</p>
        </div>
        <div class="space-y-phi-1 text-sm text-text-secondary">
          <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Mechanism</p>
          <p>Requires evidence artifacts before release.</p>
        </div>
        <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Touches</p>
        <p class="text-sm text-text-secondary">record_evidence → release_work</p>
        <a
          href={`${base}evidence#claim-evidence_gate`}
          class="text-sm text-mint hover:text-text-primary transition-colors"
        >
          Evidence &#8594;
        </a>
      </Panel>
      <Panel size="sm" class="space-y-phi-2">
        <h3 class="text-lg font-display text-text-primary">Completion gate</h3>
        <div class="space-y-phi-1 text-sm text-text-secondary">
          <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Outcome</p>
          <p>Every release includes evidence + decision.</p>
        </div>
        <div class="space-y-phi-1 text-sm text-text-secondary">
          <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Mechanism</p>
          <p>Requires decision log + evidence before release.</p>
        </div>
        <p class="text-xs uppercase tracking-[0.22em] text-text-secondary">Touches</p>
        <p class="text-sm text-text-secondary">record_decision → release_work</p>
        <a
          href={`${base}evidence#claim-completion_gate`}
          class="text-sm text-mint hover:text-text-primary transition-colors"
        >
          Evidence &#8594;
        </a>
      </Panel>
    </div>
    <p class="text-sm text-text-secondary mt-phi-3">
      See the full gate criteria in the
      <a href={`${base}implementation#phase-gates`} class="text-mint hover:text-text-primary transition-colors">
        implementation guide
      </a>.
    </p>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-4xl text-center">
    <SectionHeader
      title="Kernel Schema v0.1.3"
      size="md"
      class="mb-phi-3"
    >
      <span slot="subtitle">
        Outcome: audit-ready state in one database.
        Mechanism: attempts, decisions, evidence, blockers, and leases in
        <span class="text-text-primary font-medium"> ~/.motus/coordination.db</span>.
      </span>
    </SectionHeader>
    <a href={`${base}schema`} class="text-mint hover:text-text-primary transition-colors font-medium">
      View the schema docs &#8594;
    </a>
  </Section>

  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <SectionHeader
      title="Real Code"
      subtitle="Outcome-focused examples you can run."
      class="mb-phi-4"
      maxWidth="max-w-2xl"
    />

    <div class="space-y-phi-4">
      <Panel size="sm">
        <h3 class="text-xl font-display text-mint mb-phi-2">Outcome: deterministic Lens snapshot</h3>
        <pre class="theme-dark bg-charcoal/80 rounded-xl p-phi-2 md:p-phi-3 overflow-x-auto text-sm">
<code><span class="text-text-secondary"># Claim work and assemble a deterministic Lens</span>
<span class="text-mint">from</span> motus.api <span class="text-mint">import</span> WorkCompiler

wc = WorkCompiler()
claim = wc.claim_work(
    task_id="RI-EX-001",
    resources=[&#123;"type": "file", "path": "src/auth.py"&#125;],
    intent="Harden auth flow",
    agent_id="agent-1",
)
ctx = wc.get_context(claim.lease.lease_id, task_id="RI-EX-001")
lens = ctx.lens
</code></pre>
      </Panel>

      <Panel size="sm">
        <h3 class="text-xl font-display text-mint mb-phi-2">Outcome: receipt with outcome + evidence</h3>
        <pre class="theme-dark bg-charcoal/80 rounded-xl p-phi-2 md:p-phi-3 overflow-x-auto text-sm">
<code><span class="text-text-secondary"># Attach outcomes, evidence, and decisions</span>
lease_id = claim.lease.lease_id

wc.put_outcome(lease_id, outcome_type="file", path="src/auth.py")
wc.record_evidence(lease_id, evidence_type="test_result", test_results=&#123;"passed": 44, "failed": 0&#125;)
wc.record_decision(lease_id, decision="Ship guardrails", rationale="Stops regressions")
wc.release_work(lease_id, outcome="success")
</code></pre>
      </Panel>

      <Panel size="sm">
        <h3 class="text-xl font-display text-mint mb-phi-2">Outcome: evidence bundle verified</h3>
        <pre class="theme-dark bg-charcoal/80 rounded-xl p-phi-2 md:p-phi-3 overflow-x-auto text-sm">
<code><span class="text-text-secondary"># Verify a bundle on disk</span>
<span class="text-mint">from</span> pathlib <span class="text-mint">import</span> Path
<span class="text-mint">from</span> motus.policy.verify <span class="text-mint">import</span> verify_evidence_bundle

result = verify_evidence_bundle(evidence_dir=Path(".motus/evidence/run-001"))
<span class="text-mint">assert</span> result.ok
</code></pre>
      </Panel>
    </div>
  </Section>

  <Section tone="muted" class="text-center" innerClass="max-w-2xl">
    <SectionHeader title="Start the loop" size="md" class="mb-phi-3" />
    <p class="text-text-secondary">
      Run the six-call loop in your repo, then verify the receipt.
    </p>
    <div class="flex flex-wrap justify-center gap-phi-2 text-sm mt-phi-3">
      <a href={`${base}implementation#quickstart`} class="text-mint hover:text-text-primary transition-colors">
        Quickstart &#8594;
      </a>
      <a href={`${base}implementation`} class="text-mint hover:text-text-primary transition-colors">
        Implementation guide &#8594;
      </a>
    </div>
  </Section>
</Layout>
