---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Panel from '../components/Panel.astro';
import InstallCommand from '../components/InstallCommand.astro';
import Button from '../components/Button.astro';
import messaging from '../data/messaging.json';
import ecosystemMap from '../data/ecosystem-map.json';
import fs from 'node:fs';
import path from 'node:path';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const hero = messaging.hero || {};
const heroSubheadline = hero.subheadline || 'Motus knows.';
const heroValueProp = hero.value_prop || 'Every action logged. Every decision recorded. Every outcome a receipt.';
const heroCtaText = hero.cta_text || 'Get your first receipt';
const heroCtaPath = hero.cta_url ? hero.cta_url.replace(/^\/+/, '') : 'get-started';
const heroCtaHref = `${base}${heroCtaPath}`;

const proofDir = path.resolve(process.cwd(), '../../docs/proof/token-reduction');
const manualLog = fs.readFileSync(path.join(proofDir, 'without-motus.log'), 'utf-8');
const motusLog = fs.readFileSync(path.join(proofDir, 'with-motus.log'), 'utf-8');
const tokenResults = JSON.parse(fs.readFileSync(path.join(proofDir, 'results.json'), 'utf-8'));
const manualUnits = tokenResults.manual_units ?? 0;
const motusUnits = tokenResults.motus_units ?? 0;
const unitLabelRaw = tokenResults.unit_label || 'tokens';
const unitLabel = unitLabelRaw === 'chars' ? 'characters' : unitLabelRaw;
const formatUnits = (value: number) => new Intl.NumberFormat('en-US').format(value);

const ecosystemNodes = ecosystemMap.nodes || [];
const internalNodes = ecosystemNodes.filter((node) => node.origin === 'internal');
const currentNodes = internalNodes.filter((node) => node.status === 'current');
const buildingNodes = internalNodes.filter((node) => node.status === 'building');
const futureNodes = internalNodes.filter((node) => node.status === 'future');

const currentCore = currentNodes.filter((node) => node.group === 'core');
const currentGovernance = currentNodes.filter((node) => node.group === 'governance');
const buildingModules = buildingNodes.filter((node) => node.group === 'modules');
const futureEconomy = futureNodes.filter((node) => node.group === 'future');
---

<Layout title="Motus - What did your agent actually do?">
  <!-- HERO -->
  <Section tone="dark" pad="hero" class="text-center" innerClass="max-w-5xl">
    <h1 class="text-3xl md:text-5xl lg:text-6xl font-display text-text-secondary mb-phi-2">
      What did your agent <span class="whitespace-nowrap">actually do?</span>
    </h1>
    <p class="text-4xl md:text-6xl lg:text-7xl font-display text-mint mb-phi-4">
      {heroSubheadline}
    </p>

    <p class="text-lg md:text-xl text-text-secondary mb-phi-3 max-w-2xl mx-auto">
      {heroValueProp}
    </p>

    <div class="flex flex-col sm:flex-row gap-phi-3 justify-center items-center mb-phi-4">
      <InstallCommand />
      <Button href={heroCtaHref} variant="secondary">
        {heroCtaText} &#8594;
      </Button>
    </div>

    <p class="text-sm text-text-secondary/60">
      Works with Claude, Codex, Gemini, and local agents.
    </p>
  </Section>

  <!-- ============================================================
       SECTION 1: WORKFLOW COMPRESSION
       Light background, side-by-side code comparison
       ============================================================ -->
  <Section tone="light" pad="tight" innerClass="max-w-5xl">
    <p class="text-xs uppercase tracking-[0.2em] text-mint mb-phi-2 text-center">Workflow Compression</p>

    <h2 class="text-4xl md:text-5xl lg:text-6xl font-display text-text-primary mb-phi-2 text-center">
      See the difference
    </h2>

    <p class="text-lg text-text-secondary text-center mb-phi-5 max-w-2xl mx-auto">
      A 3-step handoff: {formatUnits(manualUnits)} {unitLabel} manually. {formatUnits(motusUnits)} {unitLabel} with Motus receipts.
    </p>

    <!-- Side-by-side comparison - equal height panels -->
    <div class="grid md:grid-cols-2 gap-phi-4 mb-phi-4 items-stretch">
      <!-- WITHOUT MOTUS -->
      <div class="rounded-xl border border-line/50 overflow-hidden bg-surface flex flex-col">
        <div class="px-phi-3 py-phi-2 border-b border-line/30 bg-surface-muted/50">
          <p class="text-xs uppercase tracking-wider text-text-secondary/60">Without Motus</p>
        </div>
        <!-- theme-dark overrides text colors for dark bg inside light section -->
        <div class="p-phi-4 font-mono text-sm bg-charcoal text-text-secondary overflow-x-auto overflow-y-auto max-h-96 flex-1 theme-dark">
          <pre class="whitespace-pre-wrap"><code lang="text">{manualLog}</code></pre>
        </div>
        <div class="px-phi-3 py-phi-2 border-t border-line/30 bg-surface-muted/30 mt-auto">
          <p class="text-sm text-text-secondary/60 font-mono">{formatUnits(manualUnits)} {unitLabel}</p>
        </div>
      </div>

      <!-- WITH MOTUS -->
      <div class="rounded-xl border border-mint/30 overflow-hidden bg-surface flex flex-col">
        <div class="px-phi-3 py-phi-2 border-b border-mint/20 bg-mint/5">
          <p class="text-xs uppercase tracking-wider text-mint">With Motus</p>
        </div>
        <!-- theme-dark overrides text colors for dark bg inside light section -->
        <div class="p-phi-4 font-mono text-sm bg-charcoal text-text-secondary overflow-x-auto overflow-y-auto max-h-96 flex-1 theme-dark">
          <pre class="whitespace-pre-wrap"><code lang="text">{motusLog}</code></pre>
        </div>
        <div class="px-phi-3 py-phi-2 border-t border-mint/20 bg-mint/5 mt-auto">
          <p class="text-sm text-mint font-mono">{formatUnits(motusUnits)} {unitLabel}</p>
        </div>
      </div>
    </div>

    <!-- Proof link -->
    <div class="text-center">
      <a
        href="https://github.com/motus-os/motus/tree/main/docs/proof/token-reduction"
        target="_blank"
        rel="noopener"
        class="inline-flex items-center gap-phi-1 text-sm text-mint hover:underline"
      >
        View the example logs
        <span aria-hidden="true">&#8594;</span>
      </a>
    </div>
  </Section>

  <!-- ============================================================
       SECTION 2: MULTI-AGENT ORCHESTRATION
       Dark background, receipt chain flow
       ============================================================ -->
  <Section tone="dark" pad="tight" innerClass="max-w-5xl">
    <p class="text-xs uppercase tracking-[0.2em] text-mint mb-phi-2 text-center">Multi-Agent</p>

    <h2 class="text-4xl md:text-5xl lg:text-6xl font-display text-text-primary mb-phi-2 text-center">
      Receipts move across providers<span class="text-mint">.</span>
    </h2>

    <p class="text-lg text-text-secondary text-center mb-phi-5 max-w-2xl mx-auto">
      Receipts are the handoff format across Claude, Codex, Gemini, and local agents.
    </p>

    <!-- Receipt chain flow -->
    <div class="flex flex-col md:flex-row items-center justify-center gap-phi-3 md:gap-phi-2 mb-phi-5">
      <!-- Receipt 1 -->
      <div class="w-full md:w-auto">
        <Panel tone="dark" size="sm" class="text-center min-w-[160px]">
          <p class="font-mono text-mint text-lg mb-phi-1">rx_001</p>
          <p class="text-sm text-text-secondary mb-phi-2">Data model</p>
          <div class="inline-flex items-center gap-phi-1 px-phi-2 py-1 rounded-full bg-surface-muted/50 text-xs text-text-secondary/70">
            <span class="w-2 h-2 rounded-full bg-[#cc9b7a]"></span>
            Claude
          </div>
        </Panel>
      </div>

      <!-- Arrow -->
      <div class="text-mint text-2xl md:rotate-0 rotate-90" aria-hidden="true">&#8594;</div>

      <!-- Receipt 2 -->
      <div class="w-full md:w-auto">
        <Panel tone="dark" size="sm" class="text-center min-w-[160px]">
          <p class="font-mono text-mint text-lg mb-phi-1">rx_002</p>
          <p class="text-sm text-text-secondary mb-phi-2">API endpoints</p>
          <div class="inline-flex items-center gap-phi-1 px-phi-2 py-1 rounded-full bg-surface-muted/50 text-xs text-text-secondary/70">
            <span class="w-2 h-2 rounded-full bg-[#10a37f]"></span>
            Codex
          </div>
        </Panel>
      </div>

      <!-- Arrow -->
      <div class="text-mint text-2xl md:rotate-0 rotate-90" aria-hidden="true">&#8594;</div>

      <!-- Receipt 3 -->
      <div class="w-full md:w-auto">
        <Panel tone="dark" size="sm" class="text-center min-w-[160px]">
          <p class="font-mono text-mint text-lg mb-phi-1">rx_003</p>
          <p class="text-sm text-text-secondary mb-phi-2">Integration tests</p>
          <div class="inline-flex items-center gap-phi-1 px-phi-2 py-1 rounded-full bg-surface-muted/50 text-xs text-text-secondary/70">
            <span class="w-2 h-2 rounded-full bg-[#4285f4]"></span>
            Gemini
          </div>
        </Panel>
      </div>
    </div>

    <!-- The insight -->
    <div class="max-w-2xl mx-auto text-center">
      <p class="text-text-secondary mb-phi-3">
        <span class="text-text-primary">Claude</span> builds the model. Ships a receipt.<br/>
        <span class="text-text-primary">Codex</span> reads the receipt. Builds the API.<br/>
        <span class="text-text-primary">Gemini</span> sees both. Writes the tests.
      </p>
      <p class="text-sm text-text-secondary/60">
        Receipts keep handoffs small and explicit. The logs above show the reduction.
      </p>
    </div>
  </Section>

  <!-- ============================================================
       SECTION 3: SYSTEM VISION
       Light background, current/building/future map
       ============================================================ -->
  <Section tone="light" pad="tight" innerClass="max-w-6xl">
    <p class="text-xs uppercase tracking-[0.2em] text-mint mb-phi-2 text-center">System Vision</p>

    <h2 class="text-4xl md:text-5xl lg:text-6xl font-display text-text-primary mb-phi-2 text-center">
      Current. Building. Future.
    </h2>

    <p class="text-lg text-text-secondary text-center mb-phi-5 max-w-3xl mx-auto">
      Current is released. Building is the next 3 releases. Future is beyond.
    </p>

    <div class="grid md:grid-cols-3 gap-phi-3">
      <Panel size="sm" class="space-y-phi-2">
        <div class="flex items-center gap-phi-2">
          <span class="status-badge status-current">Current</span>
          <span class="text-xs uppercase tracking-[0.25em] text-text-secondary">Released</span>
        </div>
        <p class="text-sm text-text-secondary">Shipped, documented, proven.</p>
        <div class="space-y-phi-2">
          <div class="space-y-phi-1">
            <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Core</p>
            <ul class="space-y-phi-1 text-sm text-text-secondary">
              {currentCore.map((node) => (
                <li>- {node.label}</li>
              ))}
            </ul>
          </div>
          <div class="space-y-phi-1">
            <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Governance</p>
            <ul class="space-y-phi-1 text-sm text-text-secondary">
              {currentGovernance.map((node) => (
                <li>- {node.label}</li>
              ))}
            </ul>
          </div>
        </div>
      </Panel>

      <Panel size="sm" class="space-y-phi-2">
        <div class="flex items-center gap-phi-2">
          <span class="status-badge status-building">Building</span>
          <span class="text-xs uppercase tracking-[0.25em] text-text-secondary">Next 3 releases</span>
        </div>
        <p class="text-sm text-text-secondary">Modules scheduled for the near-term release window.</p>
        <div class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Bundled Modules</p>
          <ul class="space-y-phi-1 text-sm text-text-secondary">
            {buildingModules.map((node) => (
              <li>- {node.label}</li>
            ))}
          </ul>
        </div>
      </Panel>

      <Panel size="sm" class="space-y-phi-2">
        <div class="flex items-center gap-phi-2">
          <span class="status-badge status-future">Future</span>
          <span class="text-xs uppercase tracking-[0.25em] text-text-secondary">Beyond</span>
        </div>
        <p class="text-sm text-text-secondary">Longer-term layers held back until verified.</p>
        <div class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Future Economy</p>
          <ul class="space-y-phi-1 text-sm text-text-secondary">
            {futureEconomy.map((node) => (
              <li>- {node.label}</li>
            ))}
          </ul>
        </div>
      </Panel>
    </div>

    <div class="mt-phi-4 flex flex-wrap items-center justify-center gap-phi-2 text-sm text-text-secondary">
      <span>Want the full map and evidence trail?</span>
      <a
        href={`${base}docs/ecosystem`}
        class="inline-flex items-center gap-phi-1 text-sm text-mint hover:underline"
      >
        Open the ecosystem map
        <span aria-hidden="true">&#8594;</span>
      </a>
    </div>
  </Section>

  <!-- FINAL CTA -->
  <Section tone="dark" pad="tight" class="text-center" innerClass="max-w-2xl">
    <h2 class="text-2xl md:text-3xl font-display text-text-primary mb-phi-2">
      Know what your agents did.
    </h2>
    <p class="text-text-secondary mb-phi-4">
      Get your first receipt with three commands.
    </p>
    <InstallCommand />
  </Section>
</Layout>
