---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Panel from '../components/Panel.astro';
import InstallCommand from '../components/InstallCommand.astro';
import SectionHeader from '../components/SectionHeader.astro';
import PersonaCard from '../components/PersonaCard.astro';
import ModuleCard from '../components/ModuleCard.astro';
import DemoLoop from '../components/DemoLoop.astro';
import personaMap from '../data/persona-map.json';
import proofLedger from '../data/proof-ledger.json';

const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
const proofIndex = new Map(proofLedger.claims.map((claim) => [claim.id, claim]));
const allowedProofStatuses = new Set(['verified', 'target']);
const evidenceAnchor = (claim) => `${base}evidence#claim-${claim.id}`;
const missingPersonaProofs = (personaMap.personas || [])
  .filter((persona) => persona.proof_id && !proofIndex.has(persona.proof_id))
  .map((persona) => persona.proof_id);

if (missingPersonaProofs.length > 0) {
  throw new Error(`Persona map references missing proof entries: ${missingPersonaProofs.join(', ')}`);
}

for (const claim of proofLedger.claims) {
  if (!claim.id) {
    throw new Error('Proof ledger claim missing id.');
  }
  if (!allowedProofStatuses.has(claim.status)) {
    throw new Error(`Proof ledger claim ${claim.id} has invalid status.`);
  }
  if (typeof claim.featured !== 'boolean') {
    throw new Error(`Proof ledger claim ${claim.id} missing featured boolean.`);
  }
  if (claim.status === 'verified' && !claim.verified_on) {
    throw new Error(`Proof ledger claim ${claim.id} missing verified_on date.`);
  }
  if (claim.status === 'verified' && !claim.method) {
    throw new Error(`Proof ledger claim ${claim.id} missing method.`);
  }
  if (!claim.momentum) {
    throw new Error(`Proof ledger claim ${claim.id} missing momentum context.`);
  }
  if (!claim.evidence || claim.evidence.length === 0 || !claim.evidence[0].url) {
    throw new Error(`Proof ledger claim ${claim.id} missing evidence.`);
  }
}
const featuredClaims = proofLedger.claims.filter((claim) => claim.featured);
const moduleHighlights = [
  {
    name: 'LENS',
    focus: 'Reading',
    summary: {
      lead: 'Precision lensing',
      rest: 'so agents read only what matters.',
    },
    bullets: [
      'Token compression lens',
      'Deterministic context slices',
      'Snapshot provenance',
    ],
    href: `${base}implementation`,
    cta: 'Explore module details',
  },
  {
    name: 'LEASES',
    focus: 'Coordination',
    summary: {
      lead: 'Six-call workflow',
      rest: 'from claim to release, without collisions.',
    },
    bullets: [
      'Lease-based handoffs',
      'Conflict detection',
      'Deterministic releases',
    ],
    href: `${base}implementation`,
    cta: 'Explore module details',
  },
  {
    name: 'RECEIPTS',
    focus: 'Trust',
    summary: {
      lead: 'Receipts for every action',
      rest: 'Cryptographic evidence, not implied trust.',
    },
    bullets: [
      'Evidence bundles',
      'Policy gates',
      'Audit trail integrity',
    ],
    href: `${base}implementation`,
    cta: 'Explore module details',
  },
  {
    name: 'STRATEGIES',
    focus: 'Reasoning',
    summary: {
      lead: 'Reusable strategies',
      rest: 'Patterns instead of ad-hoc reasoning.',
    },
    bullets: [
      'Decision patterns',
      'Trigger conditions',
      'Review heuristics',
    ],
    href: `${base}strategies`,
    cta: 'Explore module details',
  },
];
---

<Layout title="Motus - The Execution Layer for AI Agents">
  <Section tone="dark" pad="hero" class="text-center" innerClass="max-w-4xl">
    <div class="mb-phi-5 space-y-phi-2">
      <p class="text-xs uppercase tracking-[0.35em] text-text-secondary">Baseline drag</p>
      <span class="text-6xl md:text-[7.5rem] font-display font-semibold text-mint">66%</span>
      <p class="text-lg md:text-xl text-text-secondary">
        of developers spend more time fixing AI code than they saved.<a href={`${base}evidence#claim-momentum_tax_survey`} class="text-text-secondary/60 hover:text-mint transition-colors align-super text-sm ml-1" title="Stack Overflow 2024 Developer Survey">*</a>
      </p>
      <p class="text-sm text-text-secondary/80">Outcome: every task ends with a reviewable receipt.</p>
    </div>

    <div class="w-32 h-px bg-mint/70 mx-auto mb-phi-5"></div>

    <p class="text-sm uppercase tracking-[0.35em] text-text-secondary mb-phi-2">Outcome</p>
    <h1 class="text-4xl md:text-6xl font-display text-text-primary mb-phi-2">
      Reviewable execution.
    </h1>
    <p class="text-lg md:text-2xl text-text-secondary mb-phi-5">
      Mechanism: a six-call loop with evidence + decisions.
    </p>

    <div class="flex flex-col md:flex-row gap-phi-3 justify-center items-center">
      <InstallCommand />
      <a href={`${base}ecosystem`} class="text-mint hover:text-text-primary transition-colors px-phi-3 py-phi-2">
        View System Flow &#8594;
      </a>
    </div>
    <p class="text-xs uppercase tracking-[0.3em] text-text-secondary mt-phi-3">
      Proof-first momentum signals &#183; <a href={`${base}evidence`} class="text-mint hover:text-text-primary transition-colors">Evidence registry</a>
    </p>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/10">
    <SectionHeader
      eyebrow="Demo"
      title="Run a verified loop locally"
      subtitle="Outcome: a receipt with evidence + decision. Mechanism: claim → evidence → decision → release. No cloud required."
      size="md"
      align="left"
      maxWidth="max-w-3xl"
      class="mb-phi-4"
    />
    <div class="grid lg:grid-cols-[1.1fr_1fr] gap-phi-3">
      <DemoLoop />
      <div class="grid md:grid-cols-3 lg:grid-cols-1 gap-phi-3">
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Step 01</p>
          <p class="text-sm text-text-secondary">Claim a lease for the task.</p>
          <code class="text-mint font-mono text-sm block">motus work claim &lt;roadmap_id&gt; --intent &quot;Describe the task&quot;</code>
          <p class="text-xs text-text-secondary">Expected: lease_id returned.</p>
        </Panel>
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Step 02</p>
          <p class="text-sm text-text-secondary">Attach evidence + decision.</p>
          <code class="text-mint font-mono text-sm block">motus work evidence &lt;lease_id&gt; test_result --passed 12 --failed 0</code>
          <code class="text-mint font-mono text-sm block">motus work decision &lt;lease_id&gt; &quot;Decision summary&quot;</code>
          <p class="text-xs text-text-secondary">Expected: proof and rationale recorded.</p>
        </Panel>
        <Panel size="sm" class="space-y-phi-2">
          <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Step 03</p>
          <p class="text-sm text-text-secondary">Release + verify status.</p>
          <code class="text-mint font-mono text-sm block">motus work release &lt;lease_id&gt; success</code>
          <code class="text-mint font-mono text-sm block">motus work status &lt;lease_id&gt;</code>
          <p class="text-xs text-text-secondary">Expected: receipt shows outcome + evidence.</p>
        </Panel>
      </div>
    </div>
    <div class="mt-phi-3 flex flex-wrap items-center gap-phi-2 text-sm text-text-secondary">
      <span>Need the full walkthrough?</span>
      <a href={`${base}implementation#quickstart`} class="text-mint hover:text-text-primary transition-colors">
        Quickstart &#8594;
      </a>
      <span class="text-text-secondary/60">&#183;</span>
      <a href={`${base}evidence`} class="text-mint hover:text-text-primary transition-colors">
        Evidence registry &#8594;
      </a>
    </div>
  </Section>

  <Section tone="light" pad="tight" class="border-t border-line/10">
    <SectionHeader
      eyebrow="Momentum Signals"
      title="Claims tied to forward motion"
      subtitle="Lead with the outcome, then verify the mechanism."
      size="md"
      class="mb-phi-4"
      maxWidth="max-w-3xl"
    />
    <div class="flex flex-wrap justify-center items-center gap-phi-2 mb-phi-3 text-sm text-text-secondary">
      <span class="status-badge status-current">Verified</span>
      <span class="status-badge status-building">Target</span>
      <span class="text-text-secondary/60">&#183;</span>
      <a href={`${base}evidence`} class="text-mint hover:text-text-primary transition-colors">
        Evidence Registry
      </a>
    </div>
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-phi-3">
      {featuredClaims.map((claim) => {
        const statusClass = claim.status === 'verified' ? 'status-current' : 'status-building';
        const statusLabel = claim.status === 'verified' ? 'Verified' : 'Target';
        return (
          <Panel size="md" class="text-left space-y-phi-2">
            <div class="flex justify-start">
              <span class={`status-badge ${statusClass}`}>{statusLabel}</span>
            </div>
            <div>
              <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Outcome</p>
              <p class="text-lg font-display text-text-primary mt-phi-1">
                {claim.momentum}
              </p>
            </div>
            <div>
              <p class="text-xs uppercase tracking-[0.25em] text-text-secondary">Mechanism</p>
              <p class="text-sm text-text-secondary mt-phi-1">
                {claim.claim}
              </p>
            </div>
            <a
              class="text-sm text-mint hover:text-text-primary transition-colors inline-flex"
              href={evidenceAnchor(claim)}
            >
              Evidence &#8594;
            </a>
          </Panel>
        );
      })}
    </div>
    <div class="mt-phi-4 text-center">
      <p class="text-sm text-text-secondary">
        Every claim links to proof artifacts in the registry.
      </p>
      <a href={`${base}evidence`} class="inline-flex items-center gap-2 text-mint hover:text-text-primary transition-colors mt-phi-2">
        View the Evidence Registry &#8594;
      </a>
    </div>
  </Section>

  <Section tone="dark" pad="slim" class="border-y border-line/10" innerClass="max-w-4xl">
    <div class="text-center space-y-phi-2">
      <div class="flex flex-wrap items-center justify-center gap-phi-2">
        <img
          src={`${base}brand/veritas-v-white.svg`}
          alt="Veritas Collaborative"
          class="h-7 w-7 md:h-8 md:w-8"
        />
        <div class="text-left">
          <p class="text-[0.62rem] uppercase tracking-[0.35em] text-text-secondary">Maintained By</p>
          <h2 class="text-lg md:text-xl font-display text-text-primary">Veritas Collaborative, LLC</h2>
        </div>
      </div>
      <p class="text-sm text-text-secondary">
        Source-available, proof-first infrastructure for AI agent execution.
      </p>
      <div class="flex flex-wrap justify-center gap-phi-2 text-sm">
        <a href={`${base}open-source`} class="text-mint hover:text-text-primary transition-colors">
          Source access
        </a>
        <a href={`${base}license`} class="text-mint hover:text-text-primary transition-colors">
          License
        </a>
        <a href={`${base}trademarks`} class="text-mint hover:text-text-primary transition-colors">
          Trademarks
        </a>
        <a href="mailto:licensing@motusos.ai" class="text-mint hover:text-text-primary transition-colors">
          Licensing
        </a>
      </div>
    </div>
  </Section>

  <Section tone="light">
    <Panel tone="light" size="lg" class="grid md:grid-cols-2 gap-phi-5 items-center">
      <div class="space-y-phi-2">
        <p class="text-sm uppercase tracking-[0.2em] text-text-secondary">For Builders</p>
        <h2 class="text-3xl md:text-4xl font-display text-text-primary">
          Implementation Guide
        </h2>
        <p class="text-lg text-text-secondary">
          Outcome: implement without drift. Mechanism: kernel invariants, module
          boundaries, status semantics, and roadmap IDs.
        </p>
        <a
          href={`${base}implementation`}
          class="inline-flex items-center gap-2 text-mint hover:text-text-primary transition-colors"
        >
          View Implementation Guide &#8594;
        </a>
      </div>
      <Panel size="md" class="space-y-phi-2 text-sm text-text-secondary">
        <div class="flex items-start gap-phi-2">
          <span class="text-mint">&#x2022;</span>
          <span>Kernel invariants and data paths</span>
        </div>
        <div class="flex items-start gap-phi-2">
          <span class="text-mint">&#x2022;</span>
          <span>Bundled module boundaries + best practices</span>
        </div>
        <div class="flex items-start gap-phi-2">
          <span class="text-mint">&#x2022;</span>
          <span>Status semantics: current vs building vs future</span>
        </div>
        <div class="flex items-start gap-phi-2">
          <span class="text-mint">&#x2022;</span>
          <span>Roadmap IDs tied to implementation detail</span>
        </div>
      </Panel>
    </Panel>
  </Section>

  <Section tone="light" class="border-t border-line/10">
    <SectionHeader
      eyebrow="Choose Your Path"
      subtitle="Outcome: pick the right entry point with proof."
      class="mb-phi-5"
    >
      <span slot="title">Designed for the journey you are on</span>
    </SectionHeader>
    <div class="grid md:grid-cols-2 gap-phi-3">
      {personaMap.personas.map((persona) => {
        const proof = proofIndex.get(persona.proof_id);
        const path = persona.next.startsWith('/') ? persona.next.slice(1) : persona.next;
        const proofLink = proof ? `${base}evidence#claim-${proof.id}` : null;
        return (
          <PersonaCard
            title={persona.title}
            hook={persona.hook}
            value={persona.value}
            href={`${base}${path}`}
            proofLabel={proof ? proof.evidence[0].label : null}
            proofUrl={proofLink}
          />
        );
      })}
    </div>
  </Section>

  <Section tone="light">
    <SectionHeader
      subtitle="Outcome: eliminate rework in reading, coordination, trust, and reasoning."
      class="mb-phi-5"
      size="xl"
      titleClassName="display-contrast"
    >
      <span slot="title">Four Modules. <strong>Four Types of Waste Eliminated.</strong></span>
    </SectionHeader>
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-phi-3">
      {moduleHighlights.map((module) => (
        <ModuleCard
          name={module.name}
          focus={module.focus}
          summaryLead={module.summary.lead}
          summaryRest={module.summary.rest}
          bullets={module.bullets}
          href={module.href}
          cta={module.cta}
        />
      ))}
    </div>
  </Section>

  <Section tone="light" class="text-center border-t border-line/10" innerClass="max-w-4xl">
    <h2 class="text-3xl md:text-4xl font-display text-text-primary mb-phi-3">Source Available. Verifiable. Yours.</h2>
    <p class="text-lg text-text-secondary mb-phi-4 leading-relaxed">
      Outcome: audit the execution model and keep receipts local.<br class="hidden md:inline" />
      Mechanism: source-available Work Compiler + local-first storage.
    </p>

    <div class="flex flex-col md:flex-row gap-phi-3 justify-center items-center text-left md:text-center">
      <div class="flex flex-col items-start md:items-center gap-1">
        <div class="flex items-center gap-phi-1">
          <span class="text-mint text-xl">&#10003;</span>
          <span class="text-text-primary">Your receipts are YOUR data</span>
        </div>
        <a
          href={`${base}evidence#claim-coordination_db_source`}
          class="text-xs uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors"
        >
          Evidence &#8594;
        </a>
      </div>
      <div class="flex flex-col items-start md:items-center gap-1">
        <div class="flex items-center gap-phi-1">
          <span class="text-mint text-xl">&#10003;</span>
          <span class="text-text-primary">Local by default</span>
        </div>
        <a
          href={`${base}evidence#claim-no_cloud_dependency`}
          class="text-xs uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors"
        >
          Evidence &#8594;
        </a>
      </div>
      <div class="flex flex-col items-start md:items-center gap-1">
        <div class="flex items-center gap-phi-1">
          <span class="text-mint text-xl">&#10003;</span>
          <span class="text-text-primary">Audit every line of code</span>
        </div>
        <a
          href={`${base}evidence`}
          class="text-xs uppercase tracking-[0.25em] text-mint hover:text-text-primary transition-colors"
        >
          Evidence &#8594;
        </a>
      </div>
    </div>

    <div class="mt-phi-4">
      <a href="https://pypi.org/project/motusos/" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-mint hover:text-text-primary transition-colors">
        View on PyPI
      </a>
    </div>
  </Section>

  <Section tone="light" class="text-center" innerClass="max-w-2xl">
    <h2 class="text-2xl md:text-3xl font-display text-text-primary mb-phi-3">
      Ready to make your agents capable?
    </h2>
    <InstallCommand />
  </Section>
</Layout>
