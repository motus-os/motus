# Tutorial Source of Truth
# This file defines the complete "Build with Receipts" tutorial.
# CI validates every step against the current Motus release.
# Changes here trigger GIF regeneration and demo repo updates.

version: "1.1"
last_validated: "2026-01-07"
validated_against: "motusos==0.1.2"

meta:
  title: "Build a workflow runner with receipts"
  subtitle: "Implement model, API, and tests with outcomes, evidence, and decisions."
  duration_minutes: 30
  difficulty: beginner

  # Page rendering controls
  hero:
    pain: "Your agents ship code without a durable record of what happened."
    headline: "Build the workflow. Keep the receipt."
    subheadline: "Ship a 3-step workflow runner and prove every decision."
    cta_text: "Start building"
    cta_anchor: "#setup"

prerequisites:
  - id: python
    label: "Python 3.10+"
    check_command: "python3 --version"
    expected_pattern: "Python 3\\.1[0-9]"
    install_url: "https://python.org/downloads/"

  - id: pip
    label: "pip"
    check_command: "pip3 --version"
    expected_pattern: "pip"

  - id: pytest
    label: "pytest"
    check_command: "python3 -m pytest --version"
    expected_pattern: "pytest"
    install_url: "https://docs.pytest.org/"
    install_command: "pip install pytest"

setup:
  id: setup
  title: "Setup"
  status: current
  collapsed_by_default: true

  steps:
    - id: install
      title: "Install Motus"
      type: command
      command: "pip install motusos"
      expected_patterns:
        - "Successfully installed"
        - "Requirement already satisfied"
      expected_exit: 0
      timeout_seconds: 60
      skip_in_ci: true

    - id: create_dir
      title: "Create project directory"
      type: command
      command: "mkdir -p workflow-demo && cd workflow-demo"
      expected_exit: 0
      workdir: "workflow-demo"

    - id: init
      title: "Initialize Motus"
      type: command
      command: "motus init --lite --path ."
      expected_pattern: "Initialized"
      expected_exit: 0

    - id: version
      title: "Verify installation"
      type: command
      command: "motus --version"
      expected_pattern: "motus\\s+\\d+\\.\\d+\\.\\d+"
      expected_exit: 0
      gif: false

  reset_instructions: |
    If something goes wrong, reset and start over:
    ```bash
    rm -rf workflow-demo && mkdir workflow-demo && cd workflow-demo
    motus init --lite --path .
    ```

features:
  - id: ADHOC-WR-001
    title: "Model the workflow runner"
    status: current
    intent: "Define workflow and run data model"
    description: "Create the workflow model and in-memory store."

    steps:
      - id: claim
        title: "Claim the work"
        type: command
        command: "motus work claim ADHOC-WR-001 --intent \"Define workflow and run data model\""
        expected_pattern: "lease-[a-z0-9-]+"
        capture_output:
          variable: lease_model
          pattern: "lease-[a-z0-9-]+"
        expected_exit: 0
        gif: true
        gif_name: "01-claim"
        explanation: "This creates a lease - a time-bounded claim on the task."

      - id: write_model
        title: "Write the workflow model"
        type: file
        path: "src/workflow_runner.py"
        content: |
          """Workflow runner models and in-memory store."""
          from __future__ import annotations

          from dataclasses import dataclass, field
          from enum import Enum
          from typing import Dict, List
          from uuid import uuid4


          class WorkflowStatus(str, Enum):
              DRAFT = "draft"
              ACTIVE = "active"
              ARCHIVED = "archived"


          class RunStatus(str, Enum):
              QUEUED = "queued"
              RUNNING = "running"
              SUCCEEDED = "succeeded"
              FAILED = "failed"


          @dataclass
          class Step:
              id: str
              name: str
              step_type: str
              config: dict
              sort_order: int


          @dataclass
          class Workflow:
              id: str
              name: str
              status: WorkflowStatus
              steps: List[Step] = field(default_factory=list)


          @dataclass
          class Run:
              id: str
              workflow_id: str
              status: RunStatus


          class WorkflowStore:
              """In-memory store for workflows and runs."""

              def __init__(self) -> None:
                  self._workflows: Dict[str, Workflow] = {}
                  self._runs: Dict[str, Run] = {}

              def create_workflow(self, name: str, steps: List[Step]) -> Workflow:
                  workflow_id = str(uuid4())
                  workflow = Workflow(
                      id=workflow_id,
                      name=name,
                      status=WorkflowStatus.DRAFT,
                      steps=sorted(steps, key=lambda s: s.sort_order),
                  )
                  self._workflows[workflow_id] = workflow
                  return workflow

              def list_workflows(self) -> List[Workflow]:
                  return list(self._workflows.values())

              def start_run(self, workflow_id: str) -> Run:
                  run_id = str(uuid4())
                  run = Run(id=run_id, workflow_id=workflow_id, status=RunStatus.QUEUED)
                  self._runs[run_id] = run
                  return run
        explanation: "Create the core model and a simple store."

      - id: smoke_model
        title: "Sanity check the model"
        type: command
        command: "python3 -c \"import sys; sys.path.append('src'); from workflow_runner import WorkflowStore, Step; store = WorkflowStore(); wf = store.create_workflow('Demo', [Step(id='s1', name='Fetch', step_type='http', config={}, sort_order=1)]); print(wf.name)\""
        expected_pattern: "Demo"
        expected_exit: 0
        explanation: "Verify the model can create a workflow."

      - id: evidence
        title: "Record evidence"
        type: command
        command: "motus work evidence ${lease_model} log --log \"Created workflow model and in-memory store\""
        expected_pattern: "Evidence recorded"
        expected_exit: 0
        gif: true
        gif_name: "02-evidence"
        explanation: "Attach proof that the model was created."

      - id: outcome
        title: "Register the deliverable"
        type: command
        command: "motus work outcome ${lease_model} file --path src/workflow_runner.py"
        expected_pattern: "Outcome registered"
        expected_exit: 0
        explanation: "Record the file you created."

      - id: decision
        title: "Log your decision"
        type: command
        command: "motus work decision ${lease_model} \"Used dataclasses and enums for explicit workflow state\" --rationale \"Keeps the model readable and predictable\""
        expected_pattern: "Decision logged"
        expected_exit: 0
        explanation: "Explain why you chose this structure."

      - id: release
        title: "Release with receipt"
        type: command
        command: "motus work release ${lease_model} success"
        expected_pattern: "Released:"
        expected_exit: 0
        gif: true
        gif_name: "03-release"
        explanation: "Complete the work and generate the receipt."

  - id: ADHOC-WR-002
    title: "Add API wrappers"
    status: current
    intent: "Expose workflow operations via API helpers"
    description: "Add API helpers with a simple API key check."

    steps:
      - id: claim
        title: "Claim the work"
        type: command
        command: "motus work claim ADHOC-WR-002 --intent \"Expose workflow operations via API helpers\""
        expected_pattern: "lease-[a-z0-9-]+"
        capture_output:
          variable: lease_api
          pattern: "lease-[a-z0-9-]+"
        expected_exit: 0
        gif: false

      - id: write_api
        title: "Write the API helpers"
        type: file
        path: "src/api.py"
        content: |
          """API-like helpers for the workflow runner."""
          from __future__ import annotations

          from typing import List

          from workflow_runner import Step, Workflow, Run, WorkflowStore

          API_KEY = "demo-key"
          _STORE = WorkflowStore()


          class ApiError(Exception):
              pass


          def _require_key(api_key: str | None) -> None:
              if not api_key or api_key != API_KEY:
                  raise ApiError("unauthorized")


          def create_workflow(name: str, steps: List[Step], api_key: str | None) -> Workflow:
              _require_key(api_key)
              return _STORE.create_workflow(name, steps)


          def list_workflows(api_key: str | None) -> List[Workflow]:
              _require_key(api_key)
              return _STORE.list_workflows()


          def start_run(workflow_id: str, api_key: str | None) -> Run:
              _require_key(api_key)
              return _STORE.start_run(workflow_id)
        explanation: "Wrap the store with a tiny API surface."

      - id: smoke_api
        title: "Sanity check the API"
        type: command
        command: "python3 -c \"import sys; sys.path.append('src'); from api import API_KEY, create_workflow; from workflow_runner import Step; wf = create_workflow('Demo', [Step(id='s1', name='Fetch', step_type='http', config={}, sort_order=1)], api_key=API_KEY); print(wf.name)\""
        expected_pattern: "Demo"
        expected_exit: 0
        explanation: "Confirm API helpers can create a workflow."

      - id: evidence
        title: "Record evidence"
        type: command
        command: "motus work evidence ${lease_api} diff --diff \"Added API helpers for workflows and runs\""
        expected_pattern: "Evidence recorded"
        expected_exit: 0

      - id: outcome
        title: "Register deliverable"
        type: command
        command: "motus work outcome ${lease_api} file --path src/api.py"
        expected_pattern: "Outcome registered"
        expected_exit: 0

      - id: decision
        title: "Log decision"
        type: command
        command: "motus work decision ${lease_api} \"Require API key and keep a module-level store\" --rationale \"Keeps the demo focused and easy to follow\""
        expected_pattern: "Decision logged"
        expected_exit: 0

      - id: release
        title: "Release"
        type: command
        command: "motus work release ${lease_api} success"
        expected_pattern: "Released:"
        expected_exit: 0

  - id: ADHOC-WR-003
    title: "Add integration tests"
    status: current
    intent: "Add tests for workflow creation and runs"
    description: "Write tests and record the results."

    steps:
      - id: claim
        title: "Claim the work"
        type: command
        command: "motus work claim ADHOC-WR-003 --intent \"Add tests for workflow creation and runs\""
        expected_pattern: "lease-[a-z0-9-]+"
        capture_output:
          variable: lease_tests
          pattern: "lease-[a-z0-9-]+"
        expected_exit: 0

      - id: write_tests
        title: "Write the tests"
        type: file
        path: "tests/test_workflows.py"
        content: |
          """Tests for the workflow runner demo."""
          import sys

          sys.path.append("src")

          from api import API_KEY, create_workflow, list_workflows
          from workflow_runner import Step


          def test_create_and_list_workflow():
              steps = [
                  Step(id="s1", name="Fetch", step_type="http", config={}, sort_order=1),
                  Step(id="s2", name="Transform", step_type="transform", config={}, sort_order=2),
              ]
              workflow = create_workflow("Demo", steps, api_key=API_KEY)
              assert workflow.name == "Demo"

              workflows = list_workflows(api_key=API_KEY)
              assert workflow.id in [wf.id for wf in workflows]


          def test_create_workflow_requires_key():
              steps = [
                  Step(id="s1", name="Fetch", step_type="http", config={}, sort_order=1),
              ]
              try:
                  create_workflow("Unauthorized", steps, api_key=None)
              except Exception as exc:
                  assert "unauthorized" in str(exc)
        explanation: "Prove the workflow model and API behave as expected."

      - id: run_tests
        title: "Run the tests"
        type: command
        command: "PYTHONPATH=src python3 -m pytest -q"
        expected_pattern: "2 passed"
        expected_exit: 0

      - id: evidence
        title: "Record evidence"
        type: command
        command: "motus work evidence ${lease_tests} test_result --passed 2 --failed 0"
        expected_pattern: "Evidence recorded"
        expected_exit: 0

      - id: outcome
        title: "Register deliverable"
        type: command
        command: "motus work outcome ${lease_tests} file --path tests/test_workflows.py"
        expected_pattern: "Outcome registered"
        expected_exit: 0

      - id: decision
        title: "Log decision"
        type: command
        command: "motus work decision ${lease_tests} \"Keep tests in-memory for fast feedback\" --rationale \"Matches the demo scope while proving behavior\""
        expected_pattern: "Decision logged"
        expected_exit: 0

      - id: release
        title: "Release"
        type: command
        command: "motus work release ${lease_tests} success"
        expected_pattern: "Released:"
        expected_exit: 0

reveal:
  id: reveal
  title: "The Reveal"
  status: current
  description: "See all three receipts. This is what accountability looks like."

  steps:
    - id: show_leases
      title: "Review your saved lease IDs"
      type: command
      command: "echo \"Lease 1: ${lease_model}\" && echo \"Lease 2: ${lease_api}\" && echo \"Lease 3: ${lease_tests}\""
      expected_exit: 0
      explanation: "Each task got its own lease. Each lease has a receipt."

    - id: receipt_1
      title: "View receipt for Feature 1"
      type: command
      command: "motus work status ${lease_model}"
      expected_exit: 0
      expected_contains:
        - "Lease:"
        - "Status:"
        - "Agent:"
      gif: true
      gif_name: "05-reveal-1"
      explanation: "The workflow model task: outcome, evidence, and decision recorded."

    - id: receipt_2
      title: "View receipt for Feature 2"
      type: command
      command: "motus work status ${lease_api}"
      expected_exit: 0
      expected_contains:
        - "Lease:"
        - "Status:"
        - "Agent:"
      explanation: "The API helpers task: same structure, different work."

    - id: receipt_3
      title: "View receipt for Feature 3"
      type: command
      command: "motus work status ${lease_tests}"
      expected_exit: 0
      expected_contains:
        - "Lease:"
        - "Status:"
        - "Agent:"
      gif: true
      gif_name: "05-reveal-3"
      explanation: |
        You just shipped 3 features. Each one has:
        - A receipt with the outcome
        - Evidence that tests passed
        - A decision explaining your choices

        This is what your agents should produce.

demo_repo:
  name: "motus-workflow-demo"
  github_org: "motus-os"
  description: "A workflow runner demo with complete Motus audit trail"

  generated_files:
    - from_tutorial: true  # src/workflow_runner.py, src/api.py, tests/test_workflows.py

  static_files:
    - path: "README.md"
      template: "demo-repo-readme.md.jinja"

    - path: ".gitignore"
      content: |
        __pycache__/
        *.pyc
        .pytest_cache/

    - path: "requirements.txt"
      content: |
        pytest>=7.0.0
        motusos>=0.1.2

  # The .motus/ directory is copied from the validated run
  include_motus_db: true

next_steps:
  - label: "Run the same loop with your real agent"
    href: "/how-it-works"
  - label: "See advanced patterns"
    href: "/implementation"
  - label: "Explore the demo library"
    href: "/docs/demos"

# Visibility rules (matches site-wide status system)
visibility_rules:
  current:
    show: true
    interactive: true
    badge: null
  building:
    show: true
    interactive: false
    badge: "Coming Soon"
    badge_class: "status-building"
  future:
    show: false
    interactive: false
